<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="坚持保持一颗好奇心">
<meta name="keywords" content="php,java,javascript,node,go,lua,nginx,sphinx,elasticesarch,算法">
<meta property="og:type" content="website">
<meta property="og:title" content="blogs">
<meta property="og:url" content="https://wulimax.github.io/page/2/index.html">
<meta property="og:site_name" content="blogs">
<meta property="og:description" content="坚持保持一颗好奇心">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="blogs">
<meta name="twitter:description" content="坚持保持一颗好奇心">
  
    <link rel="alternate" href="/atom.xml" title="blogs" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">blogs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://wulimax.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-docs/socket/index" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/socket/index/" class="article-date">
  <time datetime="2019-09-16T07:05:48.216Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        const http = require('http')
const socketIO =require('socket.io')
const express = require('express')
const socketFn = require('./socketFn.js')
const app =express()


app.use(express.static('./www')) //定义静态文件夹
app.use(express.static('./node_modules/'))
const server = http.createServer(app)



//监听
const io = socketIO(server)
//监听连接事件
io.on('connection',socketFn)
server.listen(3000)
      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/socket/index/" data-id="ck0m2ip3y0018q4u1re885wnq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/socket/app" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/socket/app/" class="article-date">
  <time datetime="2019-09-16T07:05:48.213Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        var socketUrl = 'ws://127.0.0.1:3000' //连接
var socket = io(socketUrl) 			  

var oCanvas = document.querySelector('canvas')
var ctx = oCanvas.getContext("2d") //创建画笔 
var isDown = false //标记鼠标状态 true是按下时状态
 // 随机颜色
  var a = Math.floor(Math.random() * 255)
  var b = Math.floor(Math.random() * 255)
  var c = Math.floor(Math.random() * 255)
  var color = 'rgb('+a+','+b+', '+c+')'

  
//接收后端消息
socket.on('bedmsg',function(data){
  console.log(data)
  if(data.type == 'moveTo'){
  	ctx.beginPath()
  	ctx.strokeStyle = color
  	ctx.moveTo(data.x,data.y)
  }else{
  	ctx.lineTo(data.x,data.y)
  	ctx.stroke()
  }
})

//发给后端
//不希望服务器在发给我自己
//socket.emit('fedmsg',{a:1,b:3})

//通过canvas绘制的界面上的所有的点(moveTO,lineTo)
//收到消息后将坐标绘制到canvas中



//鼠标按下时放
oCanvas.onmousedown = function(e){

	isDown = true
	ctx.beginPath() //清洗画笔
	ctx.strokeStyle = color
	ctx.moveTo(e.offsetX,e.offsetY)
	socket.emit('fedmsg',{color:color,x:e.offsetX,y:e.offsetY,type:'moveTo'})
}
oCanvas.onmousemove = function(e){
  if(isDown){
  	ctx.lineTo(e.offsetX,e.offsetY)
  	ctx.stroke()
  	socket.emit('fedmsg',{x:e.offsetX,y:e.offsetY,type:'lineTo'})
  }
}

oCanvas.onmouseup = function (e){
    isDown = false
}


      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/socket/app/" data-id="ck0m2ip3w0017q4u19hd6m3mh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/redis/README" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/redis/README/" class="article-date">
  <time datetime="2019-09-16T07:05:48.203Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h2><p><a href="https://github.com/wulimax/blogs/blob/master/docs/redis/3.md" target="_blank" rel="noopener">1.redis 单线程 支撑并发原理</a>;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/redis/README/" data-id="ck0m2ip3u0015q4u16kzjqatk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/redis/3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/redis/3/" class="article-date">
  <time datetime="2019-09-16T07:05:48.190Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="redis缓存"><a href="#redis缓存" class="headerlink" title="redis缓存"></a>redis缓存</h2><p>文件事件处理器 IO多路复用  事件列表 事件分派处理 </p>
<p><img src="https://github.com/wulimax/blogs/blob/master/docs/img/3_1.png" alt> </p>
<p>###IO多路复用</p>
<p>IO多路复用技术是为了解决生产过程中IO阻塞等待的一种方案:有select ,poll ,epoll</p>
<p>在没有IO多路复用技术的出现的时候 计算机多采用阻塞式的方式,试想一下一个项目只能维护一个连接,服务器资源是有限的没有办法同时为多个 项目工作 , 这时候就有了IO多路复用技术 他大概思路就是 让 一个服务单独去处理 一个连接的状态<br><img src="https://github.com/wulimax/blogs/blob/master/docs/img/3_2.png" alt> </p>
<p>select :</p>
<p>​     1.单个进程能够监视的文件描述符的数量存在最大限制，通常是1024，当然可以更改数量，但由于select采用轮询的方式扫描文件描述符，文件描述符数量越多，性能越差；(在linux内核头文件中，有这样的定义：#define __FD_SETSIZE    1024)</p>
<p>​    2.内核 / 用户空间内存拷贝问题，select需要复制大量的句柄数据结构，产生巨大的开销；</p>
<ol start="3">
<li>select返回的是含有整个句柄的数组，应用程序需要遍历整个数组才能发现哪些句柄发生了事件；</li>
</ol>
<p>​    3 select的触发方式是水平触发，应用程序如果没有完成对一个已经就绪的文件描述符进行IO操作，那么之后每次select调用还是会将这些文件描述符通知进程。</p>
<p>poll : </p>
<p>​     为了解决文件限制的问题就有了poll , poll使用链表解决文件描述符的问题, 虽然解决了文件限制问题但是后三个问题依然存在</p>
<p>epoll:</p>
<p><img src="https://github.com/wulimax/blogs/blob/master/docs/img/3_3.png" alt> </p>
<p>如图所示，假设进程打开了 Socket m, n, x 等多个文件描述符，现在需要通过 epoll 来监听是 否这些 Socket 都有事件发生。其中 epoll_create 创建一个 epoll 对象，也是一个文件，也对 应一个文件描述符，同样也对应着打开文件列表中的一项。在这项里面有一个红黑树，在红黑树 里，要保存这个 epoll 要监听的所有 Socket。<br>当 epoll_ctl 添加一个 Socket 的时候，其实是加入这个红黑树，同时红黑树里面的节点指向一 个结构，将这个结构挂在被监听的 Socket 的事件列表中。当一个 Socket 来了一个事件的时 候，可以从这个列表中得到 epoll 对象，并调用 call back 通知它。<br>这种通知方式使得监听的 Socket 数据增加的时候，效率不会大幅度降低，能够同时监听的 Socket 的数目也非常的多了。上限就为系统定义的、进程打开的最大文件描述符个数。因而， epoll 被称为解决 C10K 问题的利器</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/redis/3/" data-id="ck0m2ip3u0014q4u19hf3sc5g" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/python/wx_user" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/python/wx_user/" class="article-date">
  <time datetime="2019-09-16T07:05:48.178Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="微信实现自动聊天机器人"><a href="#微信实现自动聊天机器人" class="headerlink" title="微信实现自动聊天机器人"></a>微信实现自动聊天机器人</h2><p>python  -V 查看当前python版本 </p>
<p>centos 7 安装pip</p>
<p>yum -y install epel-release</p>
<p>yum -y install python-pip</p>
<p>yum clean all</p>
<p>使用 itchat 实现 安装 itchat   pip install itchat</p>
<p><a href="https://itchat.readthedocs.io/zh/latest/" target="_blank" rel="noopener">itchat</a>是一个开源的微信个人号接口，可以使用该库进行微信网页版中的所有操作，比如：所有好友、添加好友、拉好友群聊、微信机器人等等。详细用户请看文档介绍，<a href="https://itchat.readthedocs.io/zh/latest/" target="_blank" rel="noopener">在这里</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> itchat</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用图灵机器人的api，采用爬虫的原理，根据聊天消息返回回复内容</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(text)</span>:</span></span><br><span class="line">    userId = <span class="string">'用户id'</span></span><br><span class="line">    inputText = &#123;<span class="string">'text'</span>: text&#125;</span><br><span class="line">    key = <span class="string">'自己申请的key'</span></span><br><span class="line">    userInfo = &#123;<span class="string">'apiKey'</span>: key, <span class="string">'userId'</span>: userId&#125;</span><br><span class="line">    perception = &#123;<span class="string">'inputText'</span>: inputText&#125;</span><br><span class="line">    data = &#123;<span class="string">'perception'</span>: perception, <span class="string">'userInfo'</span>: userInfo&#125;</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_answer</span><span class="params">(text)</span>:</span></span><br><span class="line">    data = get_data(text)</span><br><span class="line">    url = <span class="string">'http://openapi.tuling123.com/openapi/api/v2'</span></span><br><span class="line">    response = requests.post(url=url, data=json.dumps(data))</span><br><span class="line">    response.encoding = <span class="string">'utf-8'</span></span><br><span class="line">    result = response.json()</span><br><span class="line">    answer = result[<span class="string">'results'</span>][<span class="number">0</span>][<span class="string">'values'</span>][<span class="string">'text'</span>]</span><br><span class="line">    <span class="keyword">return</span> answer</span><br><span class="line"><span class="comment">#获取用户信息并返回</span></span><br><span class="line"><span class="meta">@itchat.msg_register(itchat.content.TEXT)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">text_reply</span><span class="params">(msg)</span>:</span></span><br><span class="line">    myself = itchat.get_friends(update=<span class="literal">True</span>)[<span class="number">0</span>][<span class="string">'NickName'</span>]</span><br><span class="line">    content = msg[<span class="string">'Content'</span>]</span><br><span class="line">    friend = msg[<span class="string">'User'</span>][<span class="string">'NickName'</span>]</span><br><span class="line">    print(msg)</span><br><span class="line">    print(friend)</span><br><span class="line">    print(<span class="string">'-------'</span>)</span><br><span class="line">    answer = get_answer(msg[<span class="string">'Text'</span>])</span><br><span class="line">    print(answer)</span><br><span class="line">    print(<span class="string">'++++++++++++++'</span>)</span><br><span class="line">    itchat.send(answer, msg[<span class="string">'FromUserName'</span>])</span><br><span class="line"></span><br><span class="line">itchat.auto_login(enableCmdQR=<span class="number">2</span>)</span><br><span class="line">itchat.run()</span><br></pre></td></tr></table></figure>

<p><a href="https://www.cnblogs.com/ouyangping/p/8453920.html" target="_blank" rel="noopener">参考资料</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/python/wx_user/" data-id="ck0m2ip3s0013q4u1chbfjhpo" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/php/thumb" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/php/thumb/" class="article-date">
  <time datetime="2019-09-16T07:05:48.164Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="GD问题"><a href="#GD问题" class="headerlink" title="GD问题"></a>GD问题</h2><p>​       公司同事反馈说我们的后台,经常图片上传失败  http状态码报500</p>
<p>​         第一阶段 : 哥们第一反应就是 他网不好让他换wifi</p>
<p>​         第二阶段: 格式不对 , 自己在后台加入 流判断</p>
<p>​         第三阶段: 图片太大 压缩一下</p>
<p>​        经历着这些应该说,总该好把 可是还是没有, 这样领导也说了 ,能不能把它弄好了,我也痛定思痛 好好研究一番问题的根源  开始解决问题：</p>
<p>​    捕获错误 : 发现捕获不了,程序直接死了;</p>
<p>​    是不是版本问题: 各种测试发现不是</p>
<p>​    内存问题:  调大内存就好了</p>
<p>​     问题是解决了但是我们不能止步于此,我们要找到其根源 为啥需要那么大的内存 比他大的图片同样的内存都可以正常上传这是为什么呢:</p>
<p><img src="https://github.com/wulimax/blogs/blob/master/img/php_thumb_1.png" alt></p>
<p><img src="https://github.com/wulimax/blogs/blob/master/img/php_thumb_2.png" alt></p>
<p>我们发现A 5.44兆 B3.75兆  ,但是A确可以正常上传 ,B就一直报错 我这种的内存是128M还报错 </p>
<p> 不跟大家卖关子了 问题出自 创建画布上 </p>
<p>GD库创建画布时是8个字节放一个像素 需要多少内存呢  计算公式 : 长 * 宽 * 8  / 1024 /1024</p>
<p>所以图片A需要 93M ; B 图片需要 181.5M</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/php/thumb/" data-id="ck0m2ip3q0011q4u1bszw6n0v" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/php/README" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/php/README/" class="article-date">
  <time datetime="2019-09-16T07:05:48.162Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="PHP相关问题"><a href="#PHP相关问题" class="headerlink" title="PHP相关问题"></a>PHP相关问题</h2><p><a href="https://github.com/wulimax/blogs/blob/master/docs/php/thumb.md" target="_blank" rel="noopener">1.一次排查GD问题记录</a>;</p>
<p><a href="https://github.com/wulimax/fs2/blob/master/swoole/READMY.md" target="_blank" rel="noopener">2.swoole基础知识</a>;</p>
<p><a href="https://github.com/wulimax/blogs/blob/master/docs/php/lru.md" target="_blank" rel="noopener">3.lru算法基本思路</a>;</p>
<p><a href="https://github.com/wulimax/blogs/blob/master/docs/php/dingding.md" target="_blank" rel="noopener">4.钉钉消息推送功能</a></p>
<p><a href="https://github.com/wulimax/blogs/blob/master/docs/php/DB.md" target="_blank" rel="noopener">5.单例数据库链接类</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/php/README/" data-id="ck0m2ip3n000yq4u18vlvt3nx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/php/phpbyte" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/php/phpbyte/" class="article-date">
  <time datetime="2019-09-16T07:05:48.153Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="先说一下要求"><a href="#先说一下要求" class="headerlink" title="先说一下要求:"></a>先说一下要求:</h2><p>提交过来前需要都处理为正整数，并且每个32位整数取低位3字节作为一个数据点，4000组3字节连续拼一起，然后整体base64编码</p>
<p>字节处理不涉及进制 所有数据都是Byte表达</p>
<p>先看一下java的实现代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> t = (<span class="keyword">double</span>) a;<span class="comment">//接受的数据是 -371659.0</span></span><br><span class="line"> Integer m = Math.abs(Integer.valueOf((<span class="keyword">int</span>) t));  <span class="comment">//先将double转成 int</span></span><br><span class="line"> <span class="keyword">byte</span>[] bytes = ByteBuffer.allocate(<span class="number">4</span>).putInt(m).array();  <span class="comment">//将int转成 byte[]</span></span><br><span class="line"><span class="comment">/**结果**/</span></span><br><span class="line">[<span class="number">0</span>,<span class="number">5</span>,-<span class="number">85</span>,-<span class="number">53</span>]</span><br></pre></td></tr></table></figure>

<p>php代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$value = abs(intval($value));<span class="comment">//接受的数据是 -371659.0 将double转成 int</span></span><br><span class="line">$tmp = toByteb($value);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换一个int为byte数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $byt 目标byte数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $val 需要转换的字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Zikie</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">toByteb</span><span class="params">($val)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $byt    = [];</span><br><span class="line">        $byt[<span class="number">0</span>] = ($val &amp; <span class="number">0xff</span>);</span><br><span class="line">        $byt[<span class="number">1</span>] = ($val &gt;&gt; <span class="number">8</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        $byt[<span class="number">2</span>] = ($val &gt;&gt; <span class="number">16</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        $byt[<span class="number">3</span>] = ($val &gt;&gt; <span class="number">24</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="keyword">return</span> $byt;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//输出结果</span></span><br><span class="line">[<span class="number">203</span>,<span class="number">171</span>,<span class="number">5</span>,<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>发现结果不一样,到底该信谁呢,  测试发现java 的可以通过  </p>
<p>php的方法错在那了, 先看看java的方法怎么实现的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ByteBuffer.allocate(4).putInt(m).array();</span></span><br><span class="line"><span class="comment">//  ByteBuffer.allocate()</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title">allocate</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (capacity &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">             <span class="comment">//调用了另一方class ,到这个对象中寻找putInt()方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HeapByteBuffer(capacity, capacity);</span><br><span class="line">    &#125;   </span><br><span class="line"><span class="comment">//putInt()方法</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> ByteBuffer <span class="title">putInt</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 感觉像是调到了无底洞</span></span><br><span class="line">        Bits.putInt(<span class="keyword">this</span>, ix(nextPutIndex(<span class="number">4</span>)), x, bigEndian);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 继续找</span></span><br><span class="line"> <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putInt</span><span class="params">(ByteBuffer bb, <span class="keyword">int</span> bi, <span class="keyword">int</span> x, <span class="keyword">boolean</span> bigEndian)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bigEndian)</span><br><span class="line">            putIntB(bb, bi, x);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            putIntL(bb, bi, x);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//继续找</span></span><br><span class="line"> <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putIntB</span><span class="params">(ByteBuffer bb, <span class="keyword">int</span> bi, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        bb._put(bi    , int3(x));</span><br><span class="line">        bb._put(bi + <span class="number">1</span>, int2(x));</span><br><span class="line">        bb._put(bi + <span class="number">2</span>, int1(x));</span><br><span class="line">        bb._put(bi + <span class="number">3</span>, int0(x));</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//找到了</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span> <span class="title">int3</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123; <span class="keyword">return</span> (<span class="keyword">byte</span>)(x &gt;&gt; <span class="number">24</span>); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span> <span class="title">int2</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123; <span class="keyword">return</span> (<span class="keyword">byte</span>)(x &gt;&gt; <span class="number">16</span>); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span> <span class="title">int1</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123; <span class="keyword">return</span> (<span class="keyword">byte</span>)(x &gt;&gt;  <span class="number">8</span>); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span> <span class="title">int0</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123; <span class="keyword">return</span> (<span class="keyword">byte</span>)(x      ); &#125;</span><br></pre></td></tr></table></figure>

<p>  看了一下每多大区别啊 回顾一下知识扫盲</p>
<p>1、因为byte占8个bit位.int占32个bit位,将int转成byte相当与强制截取int的二进制数的后8位,由于多余的部分byte空间装不下,因此干掉多余部分，取其后8位b位 转成10进制的值就是结果,</p>
<p>2、如果截下来的8位数的第一位（从左往右，术语叫做高位）是1，表示此数是负数，那么最终的结果就是 把这8位先转为十进制数然后再减去256就是最终的值</p>
<p>3、相反如果高位是0，代表正数，那么直接把这8位转为十进制数就是这个byte货色的结果</p>
<p>4、可以理解成 <strong>java 他按高位有符号处理的 php 按高位无符号处理的</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">function toByte($numdata) //$num 可以传数字</span><br><span class="line">&#123;</span><br><span class="line">    $num=decbin($numdata);  <span class="comment">//decbin 是php自带的函数，可以把十进制数字转换为二进制</span></span><br><span class="line">    <span class="comment">/**不够32前缀补零*/</span></span><br><span class="line">    $a = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i =<span class="number">0</span>;$i&lt;<span class="number">32</span>-strlen($num);$i++)&#123;</span><br><span class="line">       $a .=<span class="string">'0'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $num = $a.decbin($numdata);</span><br><span class="line">    $resdata = [];</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">4</span>;$i++)&#123;</span><br><span class="line">      $tmp=substr($num,<span class="number">8</span>*$i,<span class="number">8</span>); <span class="comment">//取后8位</span></span><br><span class="line">   	 $sign=substr($tmp,<span class="number">0</span>,<span class="number">1</span>); <span class="comment">//截取 第一位 也就是高位，用来判断到底是负的还是正的</span></span><br><span class="line">    	<span class="keyword">if</span>($sign==<span class="number">1</span>)  <span class="comment">//高位是1 代表是负数 ,则要减去256</span></span><br><span class="line">    	&#123;   	</span><br><span class="line">         $resdata[$i] = bindec($tmp)<span class="number">-256</span>; <span class="comment">//bindec 也是php自带的函数，可以把二进制数转为十进制</span></span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">else</span></span><br><span class="line">    	&#123;</span><br><span class="line">         $resdata[$i] = bindec($tmp);</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> $resdata;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考文章:<a href="http://www.hishenyi.com/archives/178" target="_blank" rel="noopener">http://www.hishenyi.com/archives/178</a> <a href="https://blog.csdn.net/fenglailea/article/details/82871746" target="_blank" rel="noopener">https://blog.csdn.net/fenglailea/article/details/82871746</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/php/phpbyte/" data-id="ck0m2ip3r0012q4u1a14646aq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/php/lru" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/php/lru/" class="article-date">
  <time datetime="2019-09-16T07:05:48.144Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="PHP实现lru算法"><a href="#PHP实现lru算法" class="headerlink" title="PHP实现lru算法"></a>PHP实现lru算法</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**使用PHP实现lru 算法 删除最长最少*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LruCache</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $lru_value = [];</span><br><span class="line">    <span class="keyword">private</span> $max_size = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($siez)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">if</span>(!<span class="keyword">empty</span>($siez))&#123;</span><br><span class="line">    		<span class="keyword">$this</span>-&gt;max_size = $siez;</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**set缓存方法*/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($key,$value)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">empty</span>($key) || <span class="keyword">empty</span>($value))&#123; <span class="keyword">return</span> <span class="keyword">false</span>; &#125;</span><br><span class="line">      <span class="comment">/**判断缓存是否在数组中存在**/</span></span><br><span class="line">      <span class="keyword">if</span>(array_key_exists($key,<span class="keyword">$this</span>-&gt;lru_value))&#123;</span><br><span class="line">           <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;lru_value[$key]); <span class="comment">//删除key;</span></span><br><span class="line">      &#125; </span><br><span class="line">      <span class="comment">/**查看是否超过maxsiex设置**/</span></span><br><span class="line">      <span class="keyword">if</span>(count(<span class="keyword">$this</span>-&gt;lru_value) &gt; <span class="keyword">$this</span>-&gt;max_size)&#123;</span><br><span class="line">      	array_shift(<span class="keyword">$this</span>-&gt;lru_value);</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="comment">/**添加key**/</span></span><br><span class="line">       <span class="keyword">$this</span>-&gt;lru_value[$key] = $value;</span><br><span class="line">       <span class="keyword">return</span> $key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**get缓存方法*/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key)</span></span>&#123;</span><br><span class="line">    	<span class="keyword">if</span>(<span class="keyword">empty</span>($key))&#123;<span class="keyword">return</span> <span class="keyword">false</span>;&#125;</span><br><span class="line">    	<span class="comment">// $key =md5($key);</span></span><br><span class="line">    	$ret_value = <span class="keyword">false</span>;</span><br><span class="line">    	<span class="keyword">if</span>(array_key_exists($key,<span class="keyword">$this</span>-&gt;lru_value))&#123;</span><br><span class="line">          $ret_value = <span class="keyword">$this</span>-&gt;lru_value[$key];</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">if</span>($ret_value)&#123;</span><br><span class="line">    		<span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;lru_value[$key]);</span><br><span class="line">    		<span class="keyword">$this</span>-&gt;lru_value[$key] = $ret_value;</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">return</span> $ret_value;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**打印缓存方法*/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">    	var_dump(<span class="keyword">$this</span>-&gt;lru_value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**动态扩展方法*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/php/lru/" data-id="ck0m2ip3o000zq4u157aj8rcp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/php/dingding" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/php/dingding/" class="article-date">
  <time datetime="2019-09-16T07:05:48.038Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="钉钉消息推送"><a href="#钉钉消息推送" class="headerlink" title="钉钉消息推送"></a>钉钉消息推送</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息通知</span></span><br><span class="line"><span class="comment"> * User:</span></span><br><span class="line"><span class="comment"> * Date: 2019/6/10</span></span><br><span class="line"><span class="comment"> * Time: 17:23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DingDing</span></span>&#123;</span><br><span class="line">    <span class="comment">/****开发钉钉通知系统********************************************/</span></span><br><span class="line">    <span class="keyword">protected</span>    $AgentId= ;</span><br><span class="line">    <span class="keyword">protected</span>    $AppKey= <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">protected</span>    $AppSecret= <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">private</span> $token = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//缓存table lru保留最近最多的使用的十个</span></span><br><span class="line">    <span class="keyword">private</span> $user_table = [];</span><br><span class="line">    <span class="keyword">private</span> $cachenum = <span class="number">10</span>;</span><br><span class="line">    <span class="comment">/**公共请求方法**/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post_url</span><span class="params">($url, $post = <span class="string">''</span>, $host = <span class="string">''</span>, $referrer = <span class="string">''</span>, $cookie = <span class="string">''</span>, $proxy = <span class="number">-1</span>, $sock = false, $useragent = <span class="string">'Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1)'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;<span class="comment">//'192.3.25.99:7808'</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($post) &amp;&amp; <span class="keyword">empty</span>($host) &amp;&amp; <span class="keyword">empty</span>($referrer) &amp;&amp; <span class="keyword">empty</span>($cookie) &amp;&amp; ($proxy == <span class="number">-1</span> || <span class="keyword">empty</span>($proxy)) &amp;&amp; <span class="keyword">empty</span>($useragent)) <span class="keyword">return</span> @file_get_contents($url);</span><br><span class="line">        $method = <span class="keyword">empty</span>($post) ? <span class="string">'GET'</span> : <span class="string">'POST'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (function_exists(<span class="string">'curl_init'</span>) &amp;&amp; <span class="keyword">empty</span>($cookie)) &#123;</span><br><span class="line">            $ch = @curl_init();</span><br><span class="line">            @curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">            <span class="keyword">if</span> ($proxy != <span class="number">-1</span> &amp;&amp; !<span class="keyword">empty</span>($proxy)) @curl_setopt($ch, CURLOPT_PROXY, <span class="string">'http://'</span> . $proxy);</span><br><span class="line">            @curl_setopt($ch, CURLOPT_REFERER, $referrer);</span><br><span class="line">            @curl_setopt($ch, CURLOPT_USERAGENT, $useragent);</span><br><span class="line">            @curl_setopt($ch, CURLOPT_COOKIEJAR, COOKIE_FILE_PATH);</span><br><span class="line">            @curl_setopt($ch, CURLOPT_COOKIEFILE, COOKIE_FILE_PATH);</span><br><span class="line">            @curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">            @curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">            @curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>);</span><br><span class="line">            @curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, <span class="number">30</span>);</span><br><span class="line">            @curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">60</span>);</span><br><span class="line">            @curl_setopt($ch, CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4);</span><br><span class="line">            <span class="keyword">if</span>(is_array($host) &amp;&amp; !is_string($host))&#123;</span><br><span class="line">                @curl_setopt($ch, CURLOPT_HTTPHEADER, $host);</span><br><span class="line">                <span class="keyword">unset</span>($host);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($method == <span class="string">'POST'</span>) &#123;</span><br><span class="line">                @curl_setopt($ch, CURLOPT_POST, <span class="number">1</span>);</span><br><span class="line">                @curl_setopt($ch, CURLOPT_POSTFIELDS, $post);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $result = @curl_exec($ch);</span><br><span class="line">            @curl_close($ch);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($result === <span class="keyword">false</span> &amp;&amp; function_exists(<span class="string">'file_get_contents'</span>)) &#123;</span><br><span class="line">            $urls = parse_url($url);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>($host)) $host = $urls[<span class="string">'host'</span>];</span><br><span class="line">            $httpheader = $method . <span class="string">" "</span> . $url . <span class="string">" HTTP/1.1\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Accept: */*\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Accept-Language: zh-cn\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Referer: "</span> . $referrer . <span class="string">"\r\n"</span>;</span><br><span class="line">            <span class="keyword">if</span> ($method == <span class="string">'POST'</span>) $httpheader .= <span class="string">"Content-Type: application/x-www-form-urlencoded\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"User-Agent: "</span> . $useragent . <span class="string">"\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Host: "</span> . $host . <span class="string">"\r\n"</span>;</span><br><span class="line">            <span class="keyword">if</span> ($method == <span class="string">'POST'</span>) $httpheader .= <span class="string">"Content-Length: "</span> . strlen($post) . <span class="string">"\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Connection: Keep-Alive\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Cookie: "</span> . $cookie . <span class="string">"\r\n"</span>;</span><br><span class="line"></span><br><span class="line">            $opts = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">'http'</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">                    <span class="string">'method'</span> =&gt; $method,</span><br><span class="line">                    <span class="string">'header'</span> =&gt; $httpheader,</span><br><span class="line">                    <span class="string">'timeout'</span> =&gt; <span class="number">60</span>,</span><br><span class="line">                    <span class="string">'content'</span> =&gt; ($method == <span class="string">'POST'</span> ? $post : <span class="string">''</span>)</span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> ($proxy != <span class="number">-1</span> &amp;&amp; !<span class="keyword">empty</span>($proxy)) &#123;</span><br><span class="line">                $opts[<span class="string">'http'</span>][<span class="string">'proxy'</span>] = <span class="string">'tcp://'</span> . $proxy;</span><br><span class="line">                $opts[<span class="string">'http'</span>][<span class="string">'request_fulluri'</span>] = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $context = @stream_context_create($opts);</span><br><span class="line">            $result = @file_get_contents($url, <span class="string">'r'</span>, $context);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($sock &amp;&amp; $result === <span class="keyword">false</span> &amp;&amp; function_exists(<span class="string">'fsockopen'</span>)) &#123;</span><br><span class="line">            $urls = parse_url($url);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>($host)) $host = $urls[<span class="string">'host'</span>];</span><br><span class="line">            $port = <span class="keyword">empty</span>($urls[<span class="string">'port'</span>]) ? <span class="number">80</span> : $urls[<span class="string">'port'</span>];</span><br><span class="line"></span><br><span class="line">            $httpheader = $method . <span class="string">" "</span> . $url . <span class="string">" HTTP/1.1\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Accept: */*\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Accept-Language: zh-cn\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Referer: "</span> . $referrer . <span class="string">"\r\n"</span>;</span><br><span class="line">            <span class="keyword">if</span> ($method == <span class="string">'POST'</span>) $httpheader .= <span class="string">"Content-Type: application/x-www-form-urlencoded\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"User-Agent: "</span> . $useragent . <span class="string">"\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Host: "</span> . $host . <span class="string">"\r\n"</span>;</span><br><span class="line">            <span class="keyword">if</span> ($method == <span class="string">'POST'</span>) $httpheader .= <span class="string">"Content-Length: "</span> . strlen($post) . <span class="string">"\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Connection: Keep-Alive\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Cookie: "</span> . $cookie . <span class="string">"\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"\r\n"</span>;</span><br><span class="line">            <span class="keyword">if</span> ($method == <span class="string">'POST'</span>) $httpheader .= $post;</span><br><span class="line">            $fd = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> ($proxy != <span class="number">-1</span> &amp;&amp; !<span class="keyword">empty</span>($proxy)) &#123;</span><br><span class="line">                $proxys = explode(<span class="string">':'</span>, $proxy);</span><br><span class="line">                $fd = @fsockopen($proxys[<span class="number">0</span>], $proxys[<span class="number">1</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $fd = @fsockopen($host, $port);</span><br><span class="line">            &#125;</span><br><span class="line">            @fwrite($fd, $httpheader);</span><br><span class="line">            @stream_set_timeout($fd, <span class="number">60</span>);</span><br><span class="line">            $result = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">while</span> (!@feof($fd)) &#123;</span><br><span class="line">                $result .= @fread($fd, <span class="number">8192</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            @fclose($fd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**文件缓存管管理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $time 默认十分钟</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filecache</span><span class="params">($key = <span class="string">''</span>,$value=<span class="string">''</span>,$time= <span class="number">600</span>,$file_path = null)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($key))&#123;<span class="keyword">return</span> <span class="keyword">false</span>;&#125;</span><br><span class="line">        <span class="comment">//优先从堆内缓存中读取</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;user_table))&#123;</span><br><span class="line">            <span class="comment">//热点数据查询</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">empty</span>($key) &amp;&amp; <span class="keyword">empty</span>($value))&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;user_table[$key]))&#123;</span><br><span class="line">                  <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;user_table[$key][<span class="string">'time'</span>] &gt; time())&#123;</span><br><span class="line">                      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;user_table[$key][<span class="string">'value'</span>];</span><br><span class="line">                  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                      <span class="comment">//删除过期数据</span></span><br><span class="line">                      <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;user_table[$key]);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//添加默认缓存存储文件</span></span><br><span class="line">        <span class="keyword">if</span>($file_path == <span class="keyword">null</span>)&#123;</span><br><span class="line">            $file_path =<span class="string">''</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $resData = <span class="keyword">null</span>;</span><br><span class="line">        $cacheData =[];</span><br><span class="line">        <span class="keyword">if</span>(is_file($file_path)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;readTxt($file_path) <span class="keyword">as</span> $item) &#123;</span><br><span class="line">                $item = json_decode($item, <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">if</span> ($item[<span class="string">'time'</span>] &lt; time()) &#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">                <span class="comment">//查询</span></span><br><span class="line">                <span class="keyword">if</span>(!<span class="keyword">empty</span>($key) &amp;&amp; <span class="keyword">empty</span>($value) &amp;&amp; $item[<span class="string">'key'</span>] == $key)&#123;</span><br><span class="line">                    <span class="comment">//清除老生代数据</span></span><br><span class="line">                    <span class="keyword">if</span>(count(<span class="keyword">$this</span>-&gt;user_table) &gt; <span class="keyword">$this</span>-&gt;cachenum)&#123;</span><br><span class="line">                        array_shift(<span class="keyword">$this</span>-&gt;user_table);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//更新数据热度</span></span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;user_table))&#123;</span><br><span class="line">                        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;user_table[$item[<span class="string">'key'</span>]]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;user_table[$item[<span class="string">'key'</span>]] = $item;</span><br><span class="line">                    <span class="comment">//返回命中数据</span></span><br><span class="line">                    <span class="keyword">return</span> $item[<span class="string">'value'</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                $cacheData[$item[<span class="string">'key'</span>]][<span class="string">'value'</span>] = $item[<span class="string">'value'</span>];</span><br><span class="line">                $cacheData[$item[<span class="string">'key'</span>]][<span class="string">'time'</span>] = $item[<span class="string">'time'</span>];</span><br><span class="line">                $cacheData[$item[<span class="string">'key'</span>]][<span class="string">'key'</span>] = $item[<span class="string">'key'</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="comment">// 删除</span></span><br><span class="line">        <span class="keyword">if</span>($time == <span class="number">0</span>)&#123; <span class="keyword">unset</span>($cacheData[$key]); $resData = <span class="keyword">true</span>;&#125;</span><br><span class="line">            <span class="comment">//写入</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($value) &amp;&amp; !<span class="keyword">empty</span>($key))&#123;</span><br><span class="line">            $cacheData[$key][<span class="string">'key'</span>] = $key;</span><br><span class="line">            $cacheData[$key][<span class="string">'value'</span>] = $value;</span><br><span class="line">            $cacheData[$key][<span class="string">'time'</span>] = time()+$time;</span><br><span class="line">            <span class="comment">//写入堆内缓存</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;user_table[$key] = $cacheData[$key];</span><br><span class="line">            $resData = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">         $string = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($cacheData <span class="keyword">as</span> $item)&#123;</span><br><span class="line">            $string .= json_encode($item,<span class="number">320</span>).PHP_EOL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//持久化到硬盘</span></span><br><span class="line">        file_put_contents($file_path, $string);</span><br><span class="line">        <span class="comment">//默认false</span></span><br><span class="line">        <span class="keyword">return</span> $resData;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $value 内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $tile 姓名 || 手机号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool|mixed|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">($value=<span class="string">''</span>,$tile=<span class="string">''</span>)</span></span>&#123;</span><br><span class="line">       $userid = <span class="keyword">$this</span>-&gt;getAlluser($tile);</span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">empty</span>($tile))&#123;</span><br><span class="line">           $user_lit = [];</span><br><span class="line">           <span class="keyword">foreach</span> ($userid <span class="keyword">as</span> $item)&#123;</span><br><span class="line">               <span class="keyword">if</span>($item[<span class="string">'pname'</span>] != <span class="string">'默认发送部门'</span>)&#123; <span class="keyword">continue</span>; &#125;</span><br><span class="line">               array_push($user_lit,$item[<span class="string">'userid'</span>]);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;putMq(implode(<span class="string">','</span>,$user_lit),$value);</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;putMq(implode(<span class="string">','</span>,$userid),$value);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getToken</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;token))&#123; <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;token; &#125;</span><br><span class="line">        $resdata = <span class="keyword">$this</span>-&gt;filecache(<span class="string">'dingdingtoken'</span>);</span><br><span class="line">        <span class="keyword">if</span>($resdata)&#123; <span class="keyword">return</span> $resdata; &#125;</span><br><span class="line">        $url  = <span class="string">'https://oapi.dingtalk.com/gettoken?appkey='</span>.<span class="keyword">$this</span>-&gt;AppKey.<span class="string">'&amp;appsecret='</span>.<span class="keyword">$this</span>-&gt;AppSecret;</span><br><span class="line">        $resdata =<span class="keyword">$this</span>-&gt;post_url($url);</span><br><span class="line">        $resdata = json_decode($resdata,<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span>($resdata[<span class="string">'errcode'</span>] ==<span class="number">0</span> &amp;&amp; <span class="keyword">isset</span>($resdata[<span class="string">'access_token'</span>]))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filecache(<span class="string">'dingdingtoken'</span>,$resdata[<span class="string">'access_token'</span>],<span class="number">7000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token = $resdata[<span class="string">'access_token'</span>];</span><br><span class="line">        <span class="keyword">return</span> $resdata[<span class="string">'access_token'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**获取所有用户名,手机号,部门,部门id**/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAlluser</span><span class="params">($req= null)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($userArr))&#123; $userArr = <span class="keyword">$this</span>-&gt;filecache(<span class="string">'dingding:userall'</span>);&#125;</span><br><span class="line">        <span class="keyword">if</span>(!$userArr) &#123;</span><br><span class="line">            $url = <span class="string">'https://oapi.dingtalk.com/department/list?access_token='</span> . <span class="keyword">$this</span>-&gt;getToken();</span><br><span class="line">            $resdata = <span class="keyword">$this</span>-&gt;post_url($url);</span><br><span class="line">            $resdata = json_decode($resdata, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> ($resdata[<span class="string">'errcode'</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $userArr = [];</span><br><span class="line">            <span class="keyword">foreach</span> ($resdata[<span class="string">'department'</span>] <span class="keyword">as</span> $itme) &#123;</span><br><span class="line">                $url = <span class="string">'https://oapi.dingtalk.com/user/listbypage?access_token='</span> . <span class="keyword">$this</span>-&gt;getToken() . <span class="string">'&amp;department_id='</span> . $itme[<span class="string">'id'</span>] . <span class="string">'&amp;offset=0&amp;size=100'</span>;</span><br><span class="line">                $dpt = <span class="keyword">$this</span>-&gt;post_url($url);</span><br><span class="line">                $dpt = json_decode($dpt, <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">if</span> ($dpt[<span class="string">'errcode'</span>] != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">foreach</span> ($dpt[<span class="string">'userlist'</span>] <span class="keyword">as</span> $value) &#123;</span><br><span class="line">                    $userArr[$value[<span class="string">'userid'</span>]][<span class="string">'username'</span>] = $value[<span class="string">'name'</span>];</span><br><span class="line">                    $userArr[$value[<span class="string">'userid'</span>]][<span class="string">'userid'</span>] = $value[<span class="string">'userid'</span>];</span><br><span class="line">                    $userArr[$value[<span class="string">'userid'</span>]][<span class="string">'mobile'</span>] = $value[<span class="string">'mobile'</span>];</span><br><span class="line">                    $userArr[$value[<span class="string">'userid'</span>]][<span class="string">'pid'</span>] = $itme[<span class="string">'id'</span>];</span><br><span class="line">                    $userArr[$value[<span class="string">'userid'</span>]][<span class="string">'pname'</span>] = $itme[<span class="string">'name'</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;filecache(<span class="string">'dingding:userall'</span>, json_encode($userArr, <span class="number">320</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!is_array($userArr))&#123; $userArr = json_decode($userArr,<span class="keyword">true</span>); &#125;</span><br><span class="line">        $resData = [];</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($req))&#123;</span><br><span class="line">            <span class="keyword">if</span>(is_array($req))&#123;</span><br><span class="line">                <span class="keyword">foreach</span> ($userArr <span class="keyword">as</span> $item)&#123;</span><br><span class="line">                    <span class="keyword">foreach</span> ($req <span class="keyword">as</span> $value)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(is_string($value) &amp;&amp; $value ==$item[<span class="string">'username'</span>])&#123;array_push($resData,$item[<span class="string">'userid'</span>]);&#125;</span><br><span class="line">                        <span class="keyword">if</span>(is_numeric($value) &amp;&amp; $value ==$item[<span class="string">'mobile'</span>])&#123;array_push($resData,$item[<span class="string">'userid'</span>]);&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(is_numeric($req))&#123;</span><br><span class="line">                <span class="keyword">foreach</span> ($userArr <span class="keyword">as</span> $item)&#123;</span><br><span class="line">                    <span class="keyword">if</span>($req ==$item[<span class="string">'mobile'</span>])&#123;array_push($resData,$item[<span class="string">'userid'</span>]);&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(is_string($req))&#123;</span><br><span class="line">                <span class="keyword">foreach</span> ($userArr <span class="keyword">as</span> $item)&#123;</span><br><span class="line">                    <span class="keyword">if</span>($req ==$item[<span class="string">'username'</span>])&#123;array_push($resData,$item[<span class="string">'userid'</span>]);&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">empty</span>($resData)?$userArr:$resData;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**发送钉钉消息**/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">putMq</span><span class="params">($userid_list=<span class="string">''</span>,$value =<span class="string">''</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($userid_list) || <span class="keyword">empty</span>($value))&#123;<span class="keyword">return</span> <span class="keyword">false</span>;&#125;</span><br><span class="line">        $url = <span class="string">'https://oapi.dingtalk.com/topapi/message/corpconversation/asyncsend_v2?access_token='</span>.<span class="keyword">$this</span>-&gt;getToken();</span><br><span class="line">        $data[<span class="string">'agent_id'</span>] = <span class="keyword">$this</span>-&gt;AgentId;</span><br><span class="line">        $data[<span class="string">'userid_list'</span>] = $userid_list;</span><br><span class="line">        $data[<span class="string">'msg'</span>][<span class="string">'msgtype'</span>] = <span class="string">'text'</span>;</span><br><span class="line">        $data[<span class="string">'msg'</span>][<span class="string">'text'</span>][<span class="string">'content'</span>] = $value;</span><br><span class="line">        $data[<span class="string">'msg'</span>] = json_encode($data[<span class="string">'msg'</span>],<span class="number">320</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;post_url($url,$data);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">readTxt</span><span class="params">($filepath)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $handle = fopen($filepath, <span class="string">'rb'</span>);</span><br><span class="line">        <span class="keyword">while</span> (feof($handle)===<span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="comment"># code...</span></span><br><span class="line">            <span class="keyword">yield</span> fgets($handle);</span><br><span class="line">        &#125;</span><br><span class="line">        fclose($handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/php/dingding/" data-id="ck0m2ip3p0010q4u1wrub1294" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/09/16/url/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/09/16/README/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/09/16/docs/wx/README/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/09/16/docs/wx/intercepto/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/09/16/docs/TopN/README/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 wulimax<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>