<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="坚持保持一颗好奇心">
<meta name="keywords" content="php,java,javascript,node,go,lua,nginx,sphinx,elasticesarch,算法">
<meta property="og:type" content="website">
<meta property="og:title" content="blogs">
<meta property="og:url" content="https://wulimax.github.io/page/3/index.html">
<meta property="og:site_name" content="blogs">
<meta property="og:description" content="坚持保持一颗好奇心">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="blogs">
<meta name="twitter:description" content="坚持保持一颗好奇心">
  
    <link rel="alternate" href="/atom.xml" title="blogs" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">blogs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://wulimax.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-docs/php/DB" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/php/DB/" class="article-date">
  <time datetime="2019-09-16T07:05:48.008Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>使用PHP PDO 连接</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PHP实现数据库连接类</span></span><br><span class="line"><span class="comment"> * 使用单例模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DB</span></span></span><br><span class="line"><span class="class"></span>&#123;   <span class="comment">//私有静态的 实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $instance = <span class="keyword">NULL</span> ;<span class="comment">//实例</span></span><br><span class="line">	<span class="comment">//私有的成员属性</span></span><br><span class="line">	<span class="keyword">private</span> $db_type = <span class="string">'mysql'</span>;	<span class="comment">//数据库类型</span></span><br><span class="line">	<span class="keyword">private</span> $db_host = <span class="string">'127.0.0.1'</span>;	<span class="comment">//主机名</span></span><br><span class="line">	<span class="keyword">private</span> $db_port = <span class="string">'3306'</span>;	<span class="comment">//端口号</span></span><br><span class="line">	<span class="keyword">private</span> $db_user = <span class="string">'root'</span>;	<span class="comment">//用户名</span></span><br><span class="line">	<span class="keyword">private</span> $db_pass = <span class="string">'123456'</span>;	<span class="comment">//密码</span></span><br><span class="line">	<span class="keyword">private</span> $db_name = <span class="string">'company'</span>;	<span class="comment">//数据库名</span></span><br><span class="line">	<span class="keyword">private</span> $charset = <span class="string">'utf8'</span>;	<span class="comment">//字符集</span></span><br><span class="line">	<span class="keyword">private</span>  $pdo = <span class="keyword">NULL</span>;<span class="comment">//PDO对象</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//构造方法</span></span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;createPDO(); <span class="comment">//创建PDO对象</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;setErrMode(); <span class="comment">//设置PDO报错的模式</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="comment">//同意实例访问入口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//判断类实付实例化</span></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="keyword">self</span>::$instance <span class="keyword">instanceof</span> <span class="keyword">self</span>))&#123;</span><br><span class="line">    	  <span class="keyword">self</span>::$instance = <span class="keyword">new</span> <span class="keyword">self</span>;    </span><br><span class="line">		  <span class="keyword">return</span> <span class="keyword">self</span>::$instance;</span><br><span class="line">    	&#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">self</span>::$instance;</span><br><span class="line">    	</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//私有的创建PDO对象的方法</span></span><br><span class="line">	<span class="keyword">private</span>  <span class="function"><span class="keyword">function</span> <span class="title">createPDO</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			<span class="comment">//构建连接数据库的基本信息</span></span><br><span class="line">			$dsn = <span class="string">"&#123;$this-&gt;db_type&#125;:host=&#123;$this-&gt;db_host&#125;;port=&#123;$this-&gt;db_port&#125;;"</span>;</span><br><span class="line">			$dsn .= <span class="string">"dbname=&#123;$this-&gt;db_name&#125;;charset=&#123;$this-&gt;charset&#125;"</span>;</span><br><span class="line">			<span class="comment">//创建PDO对象并赋值</span></span><br><span class="line">			<span class="keyword">$this</span>-&gt;pdo = <span class="keyword">new</span> PDO($dsn,<span class="keyword">$this</span>-&gt;db_user,<span class="keyword">$this</span>-&gt;db_pass); </span><br><span class="line">		&#125;<span class="keyword">catch</span>(PDOException $e)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"&lt;h2&gt;创建PDO对象失败！&lt;/h2&gt;"</span>;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"错误编号："</span>.$e-&gt;getCode();</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"&lt;br&gt;错误行号："</span>.$e-&gt;getLine();</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"&lt;br&gt;错误文件："</span>.$e-&gt;getFile();</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"&lt;br&gt;错误信息："</span>.$e-&gt;getMessage();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//私有的设置PDO报错模式的方法</span></span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">setErrMode</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">//设置PDO的报错模式为异常模式</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;pdo-&gt;setAttribute(PDO::ATTR_ERRMODE,PDO::ERRMODE_EXCEPTION);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//公共的获取单行数据方法</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchOne</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			<span class="comment">//执行SQL语句，并返回结果集对象PDOStatement</span></span><br><span class="line">			$PDOStatement = <span class="keyword">$this</span>-&gt;pdo-&gt;query($sql);</span><br><span class="line">			<span class="comment">//从结果集对象中取出单行数据，并返回</span></span><br><span class="line">			<span class="keyword">return</span> $PDOStatement-&gt;fetch(PDO::FETCH_ASSOC);</span><br><span class="line">		&#125;<span class="keyword">catch</span>(PDOException $e)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;showMessage($e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//公共的获取多行数据方法</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchAll</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			<span class="comment">//执行SQL语句，并返回结果集对象PDOStatement</span></span><br><span class="line">			$PDOStatement = <span class="keyword">$this</span>-&gt;pdo-&gt;query($sql);</span><br><span class="line">			<span class="comment">//从结果集对象中取出多行数据，并返回</span></span><br><span class="line">			<span class="keyword">return</span> $PDOStatement-&gt;fetchAll(PDO::FETCH_ASSOC);</span><br><span class="line">		&#125;<span class="keyword">catch</span>(PDOException $e)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;showMessage($e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//公共的执行其它SQL语句的方法：insert、update、delete、set、create、alter等</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pdo-&gt;exec($sql);</span><br><span class="line">		&#125;<span class="keyword">catch</span>(PDOException $e)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;showMessage($e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//公共的获取记录数</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rowCount</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			<span class="comment">//执行SELECT语句，并返回结果集对象</span></span><br><span class="line">			$PDOStatement = <span class="keyword">$this</span>-&gt;pdo-&gt;query($sql);</span><br><span class="line">			<span class="comment">//返回记录数</span></span><br><span class="line">			<span class="keyword">return</span> $PDOStatement-&gt;rowCount();</span><br><span class="line">		&#125;<span class="keyword">catch</span>(PDOException $e)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;showMessage($e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//私有的错误处理的方法</span></span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">($e)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"&lt;h2&gt;SQL语句有问题！&lt;/h2&gt;"</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"错误编号："</span>.$e-&gt;getCode();</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"&lt;br&gt;错误行号："</span>.$e-&gt;getLine();</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"&lt;br&gt;错误文件："</span>.$e-&gt;getFile();</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"&lt;br&gt;错误信息："</span>.$e-&gt;getMessage();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/php/DB/" data-id="ck0m2ip3m000xq4u1mdwmisl0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/mysql/things" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/mysql/things/" class="article-date">
  <time datetime="2019-09-16T07:05:47.950Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>MySQL事物底层原理</p>
<p>事物日志：顺序I/O</p>
<p>顺序文件：随机I/O</p>
<p><strong>事物的状态：</strong></p>
<p>​            Active：事务的初始状态，表示事务正在执行；<br>​            Partially Commited：在最后一条语句执行之后；<br>​            Failed：发现事务无法正常执行之后；<br>​           Aborted：事务被回滚并且数据库恢复到了事务进行之前的状态之后；<br>​           Commited：成功执行整个事务； </p>
<p><strong>事物的状态转换:</strong></p>
<p><strong><img src="https://cdn.nlark.com/yuque/0/2019/png/289331/1554651166778-9607ed37-259a-4b0d-9ddc-6154e745370b.png" alt="image.png"></strong></p>
<p><strong>事物：并发执行</strong></p>
<p>​       <strong>1、</strong>提高吞吐量和资源利用率</p>
<p>​       <strong>2</strong>、减少等待时间</p>
<p><strong>事物调度:</strong></p>
<p>​     <strong>1、</strong>可恢复调度</p>
<p>​     2、无级联调度</p>
<p>###并行事物</p>
<p>所有的事务都只是串行执行的，一直都没有考虑过并行执行的问题；然而在实际工作中，并行执行的事务才是常态，然而并行任务下，却可能出现非常复杂的问题</p>
<p>​     <strong>不可恢复安排 （Nonrecoverable Schedule）</strong></p>
<p>​      当 Transaction1 在执行的过程中对 <code>id = 1</code> 的用户进行了读写，但是没有将修改的内容进行提交或者回滚，在这时 Transaction2 对同样的数据进行了读操作并提交了事务；也就是说 Transaction2 是依赖于 Transaction1 的，当 Transaction1 由于一些错误需要回滚时，因为要保证事务的原子性，需要对 Transaction2 进行回滚，但是由于我们已经提交了 Transaction2，所以我们已经没有办法进行回滚操作</p>
<p>​      当事务的数量逐渐增多时，整个恢复流程也会变得越来越复杂，如果我们想要从事务发生的错误中恢复，也不是一件那么容易的事情。</p>
<p>​    Transaction2 依赖于 Transaction1，而 Transaction3 又依赖于 Transaction1，当 Transaction1 由于执行出现问题发生回滚时，为了保证事务的原子性，就会将 Transaction2 和 Transaction3 中的工作全部回滚，这种情况也叫做<strong><em>级联回滚</em>（Cascading Rollback）</strong>，级联回滚的发生会导致大量的工作需要撤回，是我们难以接受的</p>
<p>   <strong>事物隔离级别</strong></p>
<p>​     在 SQL 标准中定义了四种数据库的事务的隔离级别：<code>READ UNCOMMITED</code>、<code>READ COMMITED</code>、<code>REPEATABLE READ</code> 和 <code>SERIALIZABLE</code>；每个事务的隔离级别其实都比上一级多解决了一个问题：</p>
<ul>
<li><code>RAED UNCOMMITED</code>：使用查询语句不会加锁，可能会读到未提交的行（Dirty Read）；</li>
<li><code>READ COMMITED</code>：只对记录加记录锁，而不会在记录之间加间隙锁，所以允许新的记录插入到被锁定记录的附近，所以再多次使用查询语句时，可能得到不同的结果（Non-Repeatable Read）；</li>
<li><code>REPEATABLE READ</code>：多次读取同一范围的数据会返回第一次查询的快照，不会返回不同的数据行，但是可能发生幻读（Phantom Read）；</li>
<li><code>SERIALIZABLE</code>：InnoDB 隐式地将全部的查询语句加上共享锁，解决了幻读的问题；</li>
</ul>
<p>以上的所有的事务隔离级别都不允许脏写入（Dirty Write），也就是当前事务更新了另一个事务已经更新但是还未提交的数据，大部分的数据库中都使用了 READ COMMITED 作为默认的事务隔离级别，但是 MySQL 使用了 REPEATABLE READ 作为默认配置；从 RAED UNCOMMITED 到 SERIALIZABLE，随着事务隔离级别变得越来越严格，数据库对于并发执行事务的性能也逐渐下降</p>
<p>  <strong>并发控制依赖的技术手段：</strong></p>
<h4 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h4><p>锁是一种最为常见的并发控制机制，在一个事务中，我们并不会将整个数据库都加锁，而是只会锁住那些需要访问的数据项， MySQL 和常见数据库中的锁都分为两种，共享锁（Shared）和互斥锁（Exclusive），前者也叫读锁，后者叫写锁。</p>
<h4 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳 :"></a>时间戳 :</h4><p>​          读时间戳<em>中包括了所有访问该记录的事务中的最大时间戳，而记录行的</em>写时间戳*中保存了将记录改到当前值的事务的时间戳</p>
<p><strong>回滚日志(undo log)和重做日志(redolog)</strong></p>
<p>   Undo Log的原理很简单，为了满足事务的原子性，在操作任何数据之前，首先将数据备份到一个地方（这个存储数据备份的地方称为Undo Log）。然后进行数据的修改。如果出现了错误或者用户执行了ROLLBACK语句，系统可以利用Undo Log中的备份将数据恢复到事务开始之前的状态。</p>
<p>​    Redo Log原理和Undo Log相反，Redo Log记录的是新数据的备份。在事务提交前，只要将Redo Log持久化即可，不需要将数据持久化。当系统崩溃时，虽然数据没有持久化，但是Redo Log已经持久化。系统可以根据Redo Log的内容，将所有数据恢复到最新的状态。</p>
<p>   <strong>Undo + Redo事务的特点</strong></p>
<p>A. 为了保证持久性，必须在事务提交前将Redo Log持久化。</p>
<p>B. 数据不需要在事务提交前写入磁盘，而是缓存在内存中。</p>
<p>C. Redo Log 保证事务的持久性。</p>
<p>D. Undo Log 保证事务的原子性。</p>
<p>E. 有一个隐含的特点，数据必须要晚于redo log写入持久存储。</p>
<p><strong>1.redo log通常是物理日志，记录的是数据页的物理修改，而不是某一行或某几行修改成怎样怎样，它用来恢复提交后的物理数据页(恢复数据页，且只能恢复到最后一次提交的位置)。</strong></p>
<p><strong>2.undo用来回滚行记录到某个版本。undo log一般是逻辑日志，根据每行记录进行记录</strong></p>
<p>redo log不是二进制日志。虽然二进制日志中也记录了innodb表的很多操作，<strong>也能实现重做的功能，</strong>但是它们之间有很大区别。</p>
<ol>
<li>二进制日志是在<strong>存储引擎的上层</strong>产生的，不管是什么存储引擎，对数据库进行了修改都会产生二进制日志。而redo log是innodb层产生的，只记录该存储引擎中表的修改。<strong>并且二进制日志先于**</strong>redo log<strong>**被记录</strong>。具体的见后文group commit小结。</li>
<li>二进制日志记录操作的方法是逻辑性的语句。即便它是基于行格式的记录方式，其本质也还是逻辑的SQL设置，如该行记录的每列的值是多少。而redo log是在物理格式上的日志，它记录的是数据库中每个页的修改。</li>
<li>二进制日志只在每次事务提交的时候一次性写入缓存中的日志”文件”。而redo log在数据准备修改前写入缓存中的redo log中，然后才对缓存中的数据执行修改操作；而且保证在发出事务提交指令时，先向缓存中的redo log写入日志，写入完成后才执行提交动作。</li>
<li>因为二进制日志只在提交的时候一次性写入，所以二进制日志中的记录方式和提交顺序有关，且一次提交对应一次记录。而redo log中是记录的物理页的修改，redo log文件中同一个事务可能多次记录，最后一个提交的事务记录会覆盖所有未提交的事务记录。例如事务T1，可能在redo log中记录了 T1-1,T1-2,T1-3，T1* 共4个操作，其中 T1* 表示最后提交时的日志记录，所以对应的数据页最终状态是 T1* 对应的操作结果。而且redo log是并发写入的，不同事务之间的不同版本的记录会穿插写入到redo log文件中，例如可能redo log的记录方式如下： T1-1,T1-2,T2-1,T2-2,T2<em>,T1-3,T1</em> 。</li>
<li>事务日志记录的是物理页的情况，它具有幂等性，因此记录日志的方式极其简练。幂等性的意思是多次操作前后状态是一样的，例如新插入一行后又删除该行，前后状态没有变化。而二进制日志记录的是所有影响数据的操作，记录的内容较多。例如插入一行记录一次，删除该行又记录一次。</li>
</ol>
<p>redo log包括两部分：一是内存中的日志缓冲(redo log buffer)，该部分日志是易失性的；二是磁盘上的重做日志文件(redo log file)，该部分日志是持久的。</p>
<p>在概念上，innodb通过<strong>force log at commit</strong>机制实现事务的持久性，即在事务提交的时候，必须先将该事务的所有事务日志写入到磁盘上的redo log file和undo log file中进行持久化。</p>
<p>为了确保每次日志都能写入到事务日志文件中，在每次将log buffer中的日志写入日志文件的过程中都会调用一次操作系统的fsync操作(即fsync()系统调用)。因为MariaDB/MySQL是工作在用户空间的，MariaDB/MySQL的log buffer处于用户空间的内存中。要写入到磁盘上的log file中(redo:ib_logfileN文件,undo:share tablespace或.ibd文件)，中间还要经过操作系统内核空间的os buffer，调用fsync()的作用就是将OS buffer中的日志刷到磁盘上的log file中。</p>
<h2 id="–-恢复-Recovery"><a href="#–-恢复-Recovery" class="headerlink" title="– 恢复(Recovery)"></a>– 恢复(Recovery)</h2><h4 id="恢复策略"><a href="#恢复策略" class="headerlink" title="恢复策略"></a>恢复策略</h4><p>未提交的事务和回滚了的事务也会记录Redo Log，因此在进行恢复时,这些事务要进行特殊的的处理.有2中不同的恢复策略：  </p>
<p> A. 进行恢复时，只重做已经提交了的事务。 </p>
<p> B. 进行恢复时，重做所有事务包括未提交的事务和回滚了的事务。然后通过Undo Log回滚那些      未提交的事务。    </p>
<h4 id="InnoDB存储引擎的恢复机制"><a href="#InnoDB存储引擎的恢复机制" class="headerlink" title="InnoDB存储引擎的恢复机制"></a>InnoDB存储引擎的恢复机制</h4><p>MySQL数据库InnoDB存储引擎使用了B策略, InnoDB存储引擎中的恢复机制有几个特点：</p>
<p>A. 在重做Redo Log时，并不关心事务性。 恢复时，没有BEGIN，也没有COMMIT,ROLLBACK的行为。也不关心每个日志是哪个事务的。尽管事务ID等事务相关的内容会记入Redo Log，这些内容只是被当作     要操作的数据的一部分。</p>
<p>B. 使用B策略就必须要将Undo Log持久化，而且必须要在写Redo Log之前将对应的Undo Log写入磁盘。Undo和Redo Log的这种关联，使得持久化变得复杂起来。为了降低复杂度，InnoDB将Undo Log看作数据，因此记录Undo Log的操作也会记录到redo log中。这样undo log就可以象数据一样缓存起来，而不用在redo log之前写入磁盘了。</p>
<p>C. 到这里，还有一个问题没有弄清楚。既然Redo没有事务性，那岂不是会重新执行被回滚了的事务？</p>
<p>确实是这样。同时Innodb也会将事务回滚时的操作也记录到redo log中。回滚操作本质上也是对数据进行修改，因此回滚时对数据的操作也会记录到Redo Log中。 一个回滚了的事务的Redo Log</p>
<p>一个被回滚了的事务在恢复时的操作就是先redo再undo，因此不会破坏数据的一致性.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>事务的 ACID 四大基本特性是保证数据库能够运行的基石，但是完全保证数据库的 ACID，尤其是隔离性会对性能有比较大影响，在实际的使用中我们也会根据业务的需求对隔离性进行调整，除了隔离性，数据库的原子性和持久性相信都是比较好理解的特性，前者保证数据库的事务要么全部执行、要么全部不执行，后者保证了对数据库的写入都是持久存储的、非易失的，而一致性不仅是数据库对本身数据的完整性的要求，同时也对开发者提出了要求 - 写出逻辑正确并且合理的事务</p>
<p>​    </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/mysql/things/" data-id="ck0m2ip3l000wq4u1htb3wrgn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/mysql/README" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/mysql/README/" class="article-date">
  <time datetime="2019-09-16T07:05:47.945Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><img src="https://github.com/wulimax/blogs/blob/master/docs/mysql/image/SQL.jpg" height="495" width="495">

<h2 id="构建mysql知识网络"><a href="#构建mysql知识网络" class="headerlink" title="构建mysql知识网络"></a>构建mysql知识网络</h2><p><img src="https://github.com/wulimax/blogs/blob/master/docs/mysql/image/mysql_nav.png" alt="知识图谱"></p>
<p><a href="https://github.com/wulimax/blogs/blob/master/docs/mysql/4.md" target="_blank" rel="noopener">1.mysql优化思路</a>;</p>
<p><a href="https://github.com/wulimax/blogs/blob/master/docs/mysql/mysql.md" target="_blank" rel="noopener">2.mysql 执行流程</a>;</p>
<p><a href="https://github.com/wulimax/blogs/blob/master/docs/mysql/things.md" target="_blank" rel="noopener">3.mysql 事物</a>;</p>
<p><a href="https://github.com/wulimax/blogs/blob/master/docs/mysql/mysql_log.md" target="_blank" rel="noopener">4.mysql 日志</a>;</p>
<p><a href="https://github.com/wulimax/blogs/blob/master/docs/mysql/mysql_innodb.md" target="_blank" rel="noopener">5.innodb引擎</a>;</p>
<p><a href="https://github.com/wulimax/blogs/blob/master/docs/mysql/2.md" target="_blank" rel="noopener">6.Explain</a>;</p>
<p><a href="https://github.com/wulimax/blogs/blob/master/docs/mysql/xlock.md" target="_blank" rel="noopener">7.记一次死锁分析记录</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/mysql/README/" data-id="ck0m2ip3g000rq4u12lo404pr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/mysql/mysql_log" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/mysql/mysql_log/" class="article-date">
  <time datetime="2019-09-16T07:05:47.935Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>mysql 执行步骤</p>
<p><img src="https://github.com/wulimax/blogs/blob/master/docs/img/mysql_log_1.png" alt></p>
<p>MySQL 可以分为 Server 层和存储引擎层两部分</p>
<p>Server 层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖 MySQL 的大多数核心服 务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都 在这一层实现，比如存储过程、触发器、视图等</p>
<p>而存储引擎层负责数据的存储和提取。其架构模式是插件式的，支持 InnoDB、MyISAM、 Memory 等多个存储引擎。现在最常用的存储引擎是 InnoDB，它从 MySQL 5.5.5 版本开始成 为了默认存储引擎</p>
<p>我们这次重点讲解的mysql中的日志</p>
<p>日志：</p>
<p>查询日志：general_log</p>
<p>慢查询日志：log_slow_queries</p>
<p>错误日志：log_error， log_warnings</p>
<p>二进制日志：binlog</p>
<p>中继日志：relay_log</p>
<p>事务日志：innodb_log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">1、查询日志</span><br><span class="line">    记录查询语句，日志存储位置：</span><br><span class="line">      文件：file</span><br><span class="line">      表：table (mysql.general_log)</span><br><span class="line">      </span><br><span class="line">    general_log=&#123;ON|OFF&#125;</span><br><span class="line">    general_log_file=HOSTNAME.log </span><br><span class="line">    log_output=&#123;FILE|TABLE|NONE&#125;</span><br><span class="line">    </span><br><span class="line">  2、慢查询日志</span><br><span class="line">    慢查询：运行时间超出指定时长的查询；</span><br><span class="line">      long_query_time</span><br><span class="line">    存储位置：</span><br><span class="line">      文件：FILE</span><br><span class="line">      表：TABLE，mysql.slog_log</span><br><span class="line">      </span><br><span class="line">    log_slow_queries=&#123;ON|OFF&#125;</span><br><span class="line">    slow_query_log=&#123;ON|OFF&#125;</span><br><span class="line">    slow_query_log_file=</span><br><span class="line">    log_output=&#123;FILE|TABLE|NONE&#125;</span><br><span class="line">    log_slow_filter=admin,filesort,filesort_on_disk,full_join,full_scan,query_cache,query_cache_miss,tmp_table,tmp_table_on_disk</span><br><span class="line">    log_slow_rate_limit</span><br><span class="line">    log_slow_verbosity</span><br><span class="line">    </span><br><span class="line">  3、错误日志</span><br><span class="line">    记录信息：</span><br><span class="line">      (1) mysqld启动和关闭过程 输出的信息； </span><br><span class="line">      (2) mysqld运行中产生的错误信息； </span><br><span class="line">      (3) event scheduler运行时产生的信息；</span><br><span class="line">      (4) 主从复制架构中，从服务器复制线程启动时产生的日志；</span><br><span class="line">      </span><br><span class="line">    log_error=</span><br><span class="line">      /var/log/mariadb/mariadb.log|OFF</span><br><span class="line">    log_warnings=&#123;ON|OFF&#125;</span><br><span class="line">    </span><br><span class="line">  4、二进制日志</span><br><span class="line">    用于记录引起数据改变或存在引起数据改变的潜在可能性的语句（STATEMENT）或改变后的结果（ROW），也可能是二者混合；</span><br><span class="line">    功用：“重放”</span><br><span class="line">    </span><br><span class="line">    binlog_format=&#123;STATEMENT|ROW|MIXED&#125;</span><br><span class="line">      STATEMENT：语句；</span><br><span class="line">      ROW：行；</span><br><span class="line">      MIXED：混编；</span><br><span class="line">      </span><br><span class="line">    查看二进制日志文件列表：</span><br><span class="line">       SHOW MASTER|BINARY LOGS;</span><br><span class="line">       </span><br><span class="line">    查看当前正在使用的二进制日志文件：</span><br><span class="line">      SHOW MASTER STATUS；</span><br><span class="line">      </span><br><span class="line">    查看二进制 日志文件中的事件：</span><br><span class="line">      SHOW BINLOG EVENTS   [IN &apos;log_name&apos;] [FROM pos] [LIMIT [offset,] row_count]</span><br><span class="line">      </span><br><span class="line">    服务器变量：</span><br><span class="line">      log_bin=/PATH/TO/BIN_LOG_FILE</span><br><span class="line">        只读变量；</span><br><span class="line">      session.sql_log_bin=&#123;ON|OFF&#125;</span><br><span class="line">        控制某会话中的“写”操作语句是否会被记录于日志文件中；</span><br><span class="line">      max_binlog_size=1073741824</span><br><span class="line">      sync_binlog=&#123;1|0&#125;</span><br><span class="line">      </span><br><span class="line">    mysqlbinlog：</span><br><span class="line">        YYYY-MM-DD hh:mm:ss</span><br><span class="line">      </span><br><span class="line">       --start-datetime=</span><br><span class="line">       --stop-datetime=</span><br><span class="line">       </span><br><span class="line">       -j, --start-position=#</span><br><span class="line">        --stop-position=#</span><br><span class="line">        </span><br><span class="line">        --user, --host, --password</span><br><span class="line">      </span><br><span class="line">    二进制日志事件格式：</span><br><span class="line">      # at 553</span><br><span class="line">      #160831  9:56:08 server id 1  end_log_pos 624   Query   thread_id=2     exec_time=0     error_code=0</span><br><span class="line">      SET TIMESTAMP=1472608568/*!*/;</span><br><span class="line">      BEGIN</span><br><span class="line">      /*!*/;</span><br><span class="line">      </span><br><span class="line">      事件的起始位置：# at 553</span><br><span class="line">      事件发生的日期时间：#160831  9:56:08</span><br><span class="line">      事件发生的服务器id：server id 1</span><br><span class="line">      事件的结束位置：end_log_pos 624</span><br><span class="line">      事件的类型：Query</span><br><span class="line">      事件发生时所在服务器执行此事件的线程的ID： thread_id=2 </span><br><span class="line">      语句的时间戳与将其写入二进制日志文件中的时间差：exec_time=0</span><br><span class="line">      错误代码：error_code=0</span><br><span class="line">      事件内容：SET TIMESTAMP=1472608568/*!*/;</span><br><span class="line">      </span><br><span class="line">  中继日志：</span><br><span class="line">    从服务器上记录下来从主服务器的二进制日志文件同步过来的事件；</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">  事务日志：</span><br><span class="line">    事务型存储引擎innodb用于保证事务特性的日志文件：</span><br><span class="line">      </span><br><span class="line">      redo log </span><br><span class="line">      undo log</span><br></pre></td></tr></table></figure>

<p>查询最近一次刷入脏页LSN记录 show engine innodb status</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/mysql/mysql_log/" data-id="ck0m2ip3k000vq4u1aero5ldk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/mysql/mysql_innodb" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/mysql/mysql_innodb/" class="article-date">
  <time datetime="2019-09-16T07:05:47.931Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="innodb具有高并发-事物-数据安全等特性"><a href="#innodb具有高并发-事物-数据安全等特性" class="headerlink" title="innodb具有高并发, 事物 ,数据安全等特性"></a>innodb具有高并发, 事物 ,数据安全等特性</h2><p>1.二叉树 平衡树 多叉树</p>
<p>首先我们先了解一下树的概念: </p>
<img src="https://github.com/wulimax/blogs/blob/master/docs/mysql/image/tree.png" height="330" width="495">

<p>二叉搜索树的特点是：每个节点的左儿子小于父节点，父节点又小于右儿子。这样如果你要查 ID_card_n2 的话，按照图中的搜索顺序就是按照 UserA -&gt; UserC -&gt; UserF -&gt; User2 这个路 径得到。这个时间复杂度是 O(log(N))。</p>
<p><strong>普通的二叉树适用场景查询比较多的情况,但是对于一个经常需要增删改的场景就显得有点鸡肋了</strong> </p>
<p>这时候你就需要保持这棵树是平衡二叉树。为了做这个保 证，更新的时间复杂度也是 O(log(N))。<br>树可以有二叉，也可以有多叉。多叉树就是每个节点有多个儿子，儿子之间的大小保证从左到右 递增。二叉树是搜索效率最高的，但是实际上大多数的数据库存储却并不使用二叉树。其原因 是，索引不止存在内存中，还要写到磁盘上。</p>
<p>想象一下一棵 100 万节点的平衡二叉树，树高 20。一次查询可能需要访问 20 个数据 块。在机械硬盘时代，从磁盘随机读一个数据块需要 10 ms 左右的寻址时间。也就是说，对于 一个 100 万行的表，如果使用二叉树来存储，单独访问一个行可能需要 20 个 10 ms 的时间， 这个查询可真够慢的。<br>为了让一个查询尽量少地读磁盘，就必须让查询过程访问尽量少的数据块。那么，我们就不应该 使用二叉树，而是要使用“N 叉”树。这里，“N 叉”树中的“N”取决于数据块的大小。<br>以 InnoDB 的一个整数字段索引为例，这个 N 差不多是 1200。这棵树高是 4 的时候，就可以 存 1200 的 3 次方个值，这已经 17 亿了。考虑到树根的数据块总是在内存中的，一个 10 亿行 的表上一个整数字段的索引，查找一个值最多只需要访问 3 次磁盘。其实，树的第二层也有很 大概率在内存中，那么访问磁盘的平均次数就更少</p>
<p>2.索引</p>
<p>​     主键索引的叶子节点存的是整行数据。在 InnoDB 里，主键索引也被称为聚簇索引, </p>
<p>​      为什么要进行逻辑删除而不要物理删除: a.公司业务需要  b.对表主键进行删除 修改操作会触发页的分裂合并 不建议用</p>
<p>​      为什么要尽量用主键索引: 数据存在于主键索引上 使用普通索引会触发回表 ,可以使用覆盖索引优化</p>
<p>​      force index 可以矫正优化器的选择</p>
<img src="https://github.com/wulimax/blogs/blob/master/docs/mysql/image/tree_1.png" height="330" width="495">

<p>​    可以看出在b+树中,叶子节点会指向他相邻的叶子节点,这样可以有效减少遍历次数</p>
<p>3.锁</p>
<p>​      全局锁: 一般用于数据库备份; 表锁 行锁</p>
<p>   <strong>两阶段锁协议</strong>，整个事务分为两个阶段，前一个阶段为加锁，后一个阶段为解锁。在加锁阶段，事务只能加锁，也可以操作数据，但不能解锁，直到事务释放第一个锁，就进入解锁阶段，此过程中事务只能解锁，也可以操作数据，不能再加锁。两阶段锁协议使得事务具有较高的并发度，因为解锁不必发生在事务结尾。它的不足是没有解决死锁的问题，因为它在加锁阶段没有顺序要求。如两个事务分别申请了A, B锁，接着又申请对方的锁，此时进入死锁状态</p>
<p> <strong>时间戳排序协议</strong>，每个事务都有一个唯一的时间戳，也就是其进入系统的时间。时间戳有大小之分，如果事务Ti比Tj先进入系统，则TS(Ti)&lt;TS(Tj)。对于每个数据项Q，有两个时间戳与其绑定：一个是W-TS(Q)，表示最近一次写数据项Q的事务的时间戳；一个是R-TS(Q)，表示最近一次读数据项Q的事务的时间戳。Thomas协议是对时间戳排序协议的改进，具体内容如下：</p>
<p>若事务Ti发起一个write(Q)，则</p>
<p>如果TS(Ti)&lt;R-TS(Q)，则表明Ti准备写的值还没来得及写入，Q就提前被读取了，所以Ti的write(Q)操作被拒绝，并且事务Ti被回滚。</p>
<p>如果TS(Ti)&lt;W-TS(Q)，表明Ti写的值已过期，比它更新的值已经写到Q上，所以Ti的write(Q)操作被拒绝。</p>
<p>剩下的情况，write(Q)操作被允许</p>
<p><strong>树形协议</strong>，假设数据项的集合满足一个偏序关系，访问数据项必须按此偏序关系的先后进行。如di-&gt;dj，则要想访问dj，必须先访问di。这种偏序关系导出一个有向无环图(DAG)，因此称为树形协议。树形协议的规则有：</p>
<p>树形协议只有独占锁；</p>
<p>事务T第一次加锁可以对任何数据项进行； </p>
<p>此后，事务T对数据项Q的加锁前提是持有Q的父亲数据项的锁； </p>
<p>对数据项的解锁可以随时进行； </p>
<p>数据项被事务T加锁并解锁之后，就不能再被事务T加锁。 </p>
<p>树形协议的优点是并发度好，因为可以较早地解锁。并且没有死锁，因为其加锁都是顺序进行的。 </p>
<p>缺点是对不需要访问的数据进行不必要的加锁</p>
<p>3.redu log</p>
<p>​       当内存数据页跟磁盘数据页内容不一致的时候，我们称这个内存页为“脏页”。内存数据写入到 磁盘后，内存和磁盘上的数据页的内容就一致了，称为“干净页”。 InnoDB 的 redo log 写满了。这时候系统会停止所有更新操作，把 checkpoint 往前推进，redo log 留出空间可以继续写。redo log是循环写    </p>
<p>​         InnoDB 每次写入的日志都有一个序号，当前写入的序号跟 checkpoint 对应的序号之间的差 值，我们假设为 N。InnoDB 会根据这个 N 算出一个范围在 0 到 100 之间的数字，这个计算公 式可以记为 F2(N)。F2(N) 算法比较复杂，你只要知道 N 越大，算出来的值越大就好了。<br>然后，根据上述算得的 F1(M) 和 F2(N) 两个值，取其中较大的值记为 R，之后引擎就可以按照 innodb_io_capacity 定义的能力乘以 R% 来控制刷脏页的速度的</p>
<p>​       <img src="https://github.com/wulimax/blogs/blob/master/docs/mysql/image/redulog.png" height="330" width="495"></p>
<p>一旦一个查询请求需要在执行过程中先 flush 掉一个脏页时，这个查询就可能要比平时慢了。而 MySQL 中的一个机制，可能让你的查询会更慢：在准备刷一个脏页的时候，如果这个数据页旁 边的数据页刚好是脏页，就会把这个“邻居”也带着一起刷掉；而且这个把“邻居”拖下水的逻 辑还可以继续蔓延，也就是对于每个邻居数据页，如果跟它相邻的数据页也还是脏页的话，也会 被放到一起刷。<br>在 InnoDB 中，innodb_flush_neighbors 参数就是用来控制这个行为的，值为 1 的时候会有上 述的“连坐”机制，值为 0 时表示不找邻居，自己刷自己的。<br>找“邻居”这个优化在机械硬盘时代是很有意义的，可以减少很多随机 IO。机械硬盘的随机 IOPS 一般只有几百，相同的逻辑操作减少随机 IO 就意味着系统性能的大幅度提升。<br>而如果使用的是 SSD 这类 IOPS 比较高的设备的话，我就建议你把 innodb_flush_neighbors 的值设置成 0。因为这时候 IOPS 往往不是瓶颈，而“只刷自己”，就能更快地执行完必要的刷 脏页操作，减少 SQL 语句响应时间。<br>在 MySQL 8.0 中，innodb_flush_neighbors 参数的默认值已经是 0 了</p>
<p>查询磁盘写能力设置 </p>
<p>show global variables like ‘%capacity%’;</p>
<p>innodb_io_capacity    200<br>innodb_io_capacity_max    2000</p>
<p>设置磁盘写能力 set global innodb_io_capacity=2000;</p>
<table>
<thead>
<tr>
<th>innodb_io_capacity</th>
<th>磁盘配置</th>
</tr>
</thead>
<tbody><tr>
<td>200</td>
<td>单盘SAS/SATA</td>
</tr>
<tr>
<td>2000</td>
<td>SAS*12  RAID  10</td>
</tr>
<tr>
<td>5000</td>
<td>SSD</td>
</tr>
<tr>
<td>50000</td>
<td>FUSION-IO</td>
</tr>
</tbody></table>
<ol start="4">
<li><p>count()</p>
<p>  有朋友问我count()是怎么回事;</p>
<p>对于 count(主键 id) 来说，</p>
<p>​                 InnoDB 引擎会遍历整张表，把每一行的 id 值都取出来，返回给 server 层。server 层拿到 id 后，判断是不可能为空的，就按行累加。<br>对于 count(1) 来说，</p>
<p>​                 InnoDB 引擎遍历整张表，但不取值。server 层对于返回的每一行，放一 个数字“1”进去，判断是不可能为空的，按行累加。<br>单看这两个用法的差别的话，你能对比出来，count(1) 执行得要比 count(主键 id) 快。因为从 引擎返回 id 会涉及到解析数据行，以及拷贝字段值的操作。<br>对于 count(字段) 来说：</p>
<ol>
<li>如果这个“字段”是定义为 not null 的话，一行行地从记录里面读出这个字段，判断不能 为 null，按行累加；</li>
<li>如果这个“字段”定义允许为 null，那么执行的时候，判断到有可能是 null，还要把值取出 来再判断一下，不是 null 才累加。<br>也就是前面的第一条原则，server 层要什么字段，InnoDB 就返回什么字段。<br>但是 count(<em>) 是例外，并不会把全部字段取出来，而是专门做了优化，不取值。count(</em>) 肯定 不是 null，按行累加</li>
</ol>
</li>
</ol>
<p>​      结论: 按照效率排序的话，count(字段)&lt;count(主键 id)&lt;count(1)≈count( * )，所以我 建议你，尽量使用 count( * );</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/mysql/mysql_innodb/" data-id="ck0m2ip3j000uq4u1ed9w133e" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/mysql/mysql" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/mysql/mysql/" class="article-date">
  <time datetime="2019-09-16T07:05:47.912Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>mysql执行流程</p>
<p>关系模型：(结构化数据模型)</p>
<p>关系模型</p>
<p>实体-关系模型</p>
<p>对象关系模型：基于对象的数据模型</p>
<p>半结构化数据模型：XML(扩展标记语言)</p>
<p>Jerry</p>
<p>50</p>
<p>gender:</p>
<p>name:<br>    uid:<br>    birthdate:</p>
<pre><code>name:age:gender
name:uid:birthdate</code></pre><p>关系：关系代数运算</p>
<p>交集：</p>
<p>并集：</p>
<p>差集：</p>
<p>全集：</p>
<p>补集：</p>
<p>SQL：Structure Query Language</p>
<p>70</p>
<p>System R: SQL</p>
<p>Ingres, Oracle, Sybase</p>
<p>ANSI: ansi-sql</p>
<p>DML：数据操作语言</p>
<p>INSERT</p>
<p>DELETE</p>
<p>SELECT</p>
<p>UPDATE</p>
<p>DDL：数据定义语言</p>
<p>CREATE</p>
<p>DROP</p>
<p>ALTER</p>
<p>DCL: 数据控制语言</p>
<p>GRANT</p>
<p>REVOKE</p>
<p>访问权限</p>
<p>RDB对象：</p>
<p>库、表、索引、视图、用户、存储过程、存储函数、触发器、事件调度器</p>
<p>约束<br>    域约束：数据类型约束<br>    外键约束：引用完整性约束<br>    主键约束：某字段能惟一标识此字段所属的实体，并且不允许为空<br>        一张表中只能有一个主键<br>    惟一性约束：每一行的某字段都不允许出现相同值，可以为空<br>        一张表中可以有多个<br>    检查性约束: age: int</p>
<p>constraint</p>
<p>/etc/passwd:</p>
<p>数据查询和存储：</p>
<p>存储管理器：</p>
<p>权限及完整性管理器</p>
<p>事务管理器</p>
<p>文件管理器</p>
<p>缓冲区管理器</p>
<p>查询管理器：</p>
<p>DML解释器</p>
<p>DDL解释器</p>
<p>查询执行引擎</p>
<p>关系运算：</p>
<p>投影：只输出指定属性</p>
<p>选择：只输出符合条件的行</p>
<p>自然连接：具有相同名字的属性上所有取值相同的行；</p>
<p>笛卡尔积：</p>
<p>(a+b)*(c+d)=ac+ad+bc+bd</p>
<p>并：集合运算</p>
<p>SQL查询语句：</p>
<p>sequel–&gt;SQL</p>
<p>SQL-86</p>
<p>SQL-89</p>
<p>SQL-92</p>
<p>SQL-99</p>
<p>SQL-03</p>
<p>SQL-08</p>
<p>SQL语言的组成部分：</p>
<p>DDL</p>
<p>DML</p>
<p>完整性定义语言：DDL的一部分功能</p>
<p>视图定义：</p>
<p>事务控制：</p>
<p>嵌入式SQL和动态SQL：</p>
<p>授权：DCL</p>
<p>使用程序设计语言如何跟RDBMS交互：</p>
<p>嵌入式SQL：与动态SQL类似，但其语言必须程序编译时完全确定下来；</p>
<p>ODBC</p>
<p>动态SQL：程序设计语言使用函数(mysql_connect())或者方法与RDBMS服务器建立连接，并进行交互；通过建立连接向SQL服务器发送查询语句，并将结果保存至变量中而后进行处理；</p>
<p>JDBC</p>
<p>表管理器：负责创建、读取或修改表定义文件；维护表描述符高速缓存；管理表锁；</p>
<p>表结构定义文件</p>
<p>表修改模块：表创建、删除、重命名、移除、更新或插入之类的操作；</p>
<p>表维护模块：检查、修改、备份、恢复、优化(碎片整理)及解析；</p>
<p>行：定长，变长</p>
<p>文件中记录组织：</p>
<p>堆文件组织：一条记录可以放在文件中的任何地方；</p>
<p>顺序文件组织：根据“搜索码”值顺序存放；</p>
<p>散列文件组织：</p>
<p>表结构定义文件，表数据文件</p>
<p>表空间：table space</p>
<p>数据字典：Data Dictionary</p>
<p>关系的元数据：</p>
<p>关系的名字</p>
<p>字段名字</p>
<p>字段的类型和长度</p>
<p>视图</p>
<p>约束</p>
<p>用户名字，授权，密码</p>
<p>缓冲区管理器：</p>
<p>缓存置换策略</p>
<p>被钉住的块</p>
<p>访问路径的选择性：一个访问路径的选择性是所有获取的页面数（如果使用这个访问路径去获取所有想要的元组）。如果一个表包含一个与给定条件相匹配的索引，就至少存在两条访问路径：使用索引和扫描整个数据文件。</p>
<p>最有选择性的路径是检索最少页数的路径；使用最有选择性的路径将使用获取数据的代价降到最小。而一个访问路径的选择性依赖于选择条件中的主合取体（与涉及的索引有关），每个合取体就好比表上的一个过滤器，满足一个给定合取的元组在表中所占的百分比称为缩减因子。</p>
<p>MySQL安装：</p>
<p>专用软件包管理器包</p>
<p>deb, rpm</p>
<p>rpm:</p>
<p>RHEL(Oracle Linux)， CentOS</p>
<p>SUSE</p>
<p>通用二进制格式包</p>
<p>gcc: x86, x64</p>
<p>源代码</p>
<p>5.5, 5.6</p>
<p>cmake</p>
<p>MySQL用户密码修改：</p>
<p>1、# mysqladmin -u USERNAME -h HOSTNAME password ‘NEW_PASS’ -p</p>
<p>2、mysql&gt; SET PASSWORD FOR ‘USERNAME’@’HOST’=PASSWORD(‘new_pass’);</p>
<p>3、mysql&gt; UPDATE mysql.user SET PASSWORD=PASSWORD(‘new_pass’) WHERE CONDITION;</p>
<p>MySQL安装：</p>
<p>源码安装MySQL</p>
<p>cmake</p>
<p>字符集：</p>
<p>人：00100110 00101010</p>
<p>人：10101011 10010001</p>
<p>汉字：字符集</p>
<p>GBK</p>
<p>GB2312</p>
<p>GB18030</p>
<p>UTF8</p>
<p>排序规则：</p>
<p>性能分析</p>
<p>MySQL客户端工具：</p>
<p>mysql</p>
<p>mysqldump</p>
<p>mysqladmin</p>
<p>mysqlcheck</p>
<p>mysqlimport</p>
<p>[client]</p>
<p>-u USERNAME<br>-h HOST<br>-p ‘’<br>–protocol {tcp|socket|pipe|memory}<br>–port PORT</p>
<p>MySQL非客户端工具</p>
<p>myisamchk</p>
<p>myisampack</p>
<p>MyISAM:</p>
<p>每表三个文件：</p>
<p>.frm: 表结构</p>
<p>.MYD：表数据</p>
<p>.MYI：表索引</p>
<p>InnoDB：</p>
<p>所有表共享一个表空间文件；</p>
<p>建议：每表一个独立的表空间文件；</p>
<p>.frm: 表结构</p>
<p>.ibd: 表空间（表数据和表索引）</p>
<p>mysql&gt;</p>
<p>mysql</p>
<p>–user, -u</p>
<p>–host, -h</p>
<p>–password, -p</p>
<p>–port</p>
<p>–protocol</p>
<p>–database DATABASE, -D</p>
<p>其它选项：</p>
<p>mysql&gt;</p>
<p>交互式模式</p>
<p>批处理模式(脚本模式)</p>
<p>mysql &lt; init.sql</p>
<p>mysql&gt;</p>
<p>命令两类：</p>
<p>客户端命令</p>
<p>服务器语句：有语句结束符，默认;</p>
<p>\d: 定义语句结束符</p>
<p>//</p>
<p>客户端命令：<br>    \c: 提前终止语句执行<br>    \g: 无论语句结束符是什么，直接将此语句送至服务器端执行；<br>    \G: 无论语句结束符是什么，直接将此语句送到服务器端执行，而且结果以竖排方式显示；<br>    ! COMMAND: 执行shell命令<br>    \W: 语句执行结束后显示警告信息；<br>    #: 对新建的对象，支持补全功能；</p>
<p>mysql&gt;</p>
<p>-&gt;</p>
<p>‘&gt;</p>
<p>“&gt;</p>
<p>`&gt;</p>
<p>补全：</p>
<p>名称补全</p>
<p>服务器端命令获取帮助：</p>
<p>help KEYWORD</p>
<p>mysqladmin [options] command [arg] [command [arg]] …</p>
<p>mysqladmin -uroot -p password ‘NEW_PASS’</p>
<p>create DATABASE<br>drop DATABASE<br>ping<br>processlist<br>status<br>    –sleep N：显示频率<br>    –count N: 显示多个状态<br>extended-status: 显示状态变量<br>variables: 显示服务器变量<br>flush-privileges: 让mysqld重读授权表, 等同于reload；<br>flush-status: 重置大多数的服务器状态变量<br>flush-logs: 二进制和中继日志滚动<br>flush-hosts:<br>refresh: 相当于同时执行flush-hosts和flush-logs<br>shutdown: 关闭mysql服务器进程<br>version: 服务器版本及当前状态信息；</p>
<p>start-slave: 启动复制，启动从服务器复制线程；<br>    SQL thread<br>    IO thread<br>stop-slave: 关闭复制；</p>
<p>mysqldump, mysqlimport, mysqlcheck</p>
<p>开发视角：</p>
<p>数据类型</p>
<p>约束</p>
<p>数据库、表、索引、视图</p>
<p>SELECT</p>
<p>RDBMS:</p>
<p>存储引擎，也被称为表类型：</p>
<p>MyISAM表: 无事务，表锁</p>
<p>.frm: 表结构定义文件</p>
<p>.MYD: 表数据</p>
<p>.MYI: 索引</p>
<p>InnoDB表：事务，行锁</p>
<p>.frm: 表结构</p>
<p>.ibd: 表空间（数据和索引）</p>
<p>MySQL:</p>
<p>mysql: MyISAM</p>
<p>SHOW ENGINES</p>
<p>SHOW TABLE STATUS [LIKE …]</p>
<p>程序语言连接数据的方式：</p>
<p>动态SQL：通过函数或方法与数据库服务建立连接，</p>
<p>嵌入式SQL：</p>
<p>JDBC, ODBC</p>
<p>客户端：mysql、mysqladmin、mysqldump、mysqlimport、mysqlcheck</p>
<p>服务器：mysqld, mysqld_safe, mysqld_multi</p>
<p>my.cnf</p>
<p>/etc/my.cnf –&gt; /etc/mysql/my.cnf –&gt; $MYSQL_HOME/my.cnf –&gt; –default-extra-file=/path/to/somefile –&gt; ~/.my.cnf</p>
<p>[mysqld]</p>
<p>[mysqld_safe]</p>
<p>[client]</p>
<p>host =</p>
<p>[mysql]</p>
<p>mysqld –help –verbose</p>
<p>datadir = /mydata/data</p>
<p>hostname.err: 错误日志</p>
<p>1、此前服务未关闭；</p>
<p>2、数据初始化失败；</p>
<p>3、数据目录位置错误；</p>
<p>4、数据目录权限问题；</p>
<p>DBA:</p>
<p>开发DBA：数据库设计、SQL语句、存储过程、存储函数、触发器</p>
<p>管理DBA：安装、升级、备份、恢复、用户管理、权限管理、监控、性能分析、基准测试</p>
<p>数据类型：</p>
<p>数值型</p>
<p>精确数值</p>
<p>int</p>
<p>decimal</p>
<p>近似数值</p>
<p>float</p>
<p>double</p>
<p>real</p>
<p>字符型</p>
<p>定长：CHAR(#)、BINARY</p>
<p>变长：VARCHAR(#)、VARBINARY</p>
<p>text, blob</p>
<p>ENUM, SET</p>
<p>日期时间型<br>    date, time, datetime, timestamp</p>
<p>域属性，修改符：</p>
<p>数据类型：</p>
<p>1、存入的值类型；</p>
<p>2、占据的存储空间；</p>
<p>3、定长还变长；</p>
<p>4、如何比较及排序；</p>
<p>5、是否能够索引；</p>
<p>SQL</p>
<p>mysql&gt; SHOW CHARACTER SET;</p>
<p>mysql&gt; SHOW COLLATION;</p>
<p>AUTO_INCREMENT</p>
<p>整型</p>
<p>非空</p>
<p>无符号</p>
<p>主键或惟一键</p>
<p>CREATE TABLE test(ID INT UNSIGNED AUTO_INCREMENT NOT NULL PRIMARY KEY, Name CHAR(20))</p>
<p>mysql&gt; SELECT LAST_INSERT_ID();</p>
<p>DNS</p>
<p>RRtype CHAR(5)</p>
<p>A, PTR, CNAME, AAAA, MX, NS, SOA, SRV</p>
<p>RRtype ENUM(‘A’,’PTR’)</p>
<p>SQL模型：</p>
<p>abc, abcdefg</p>
<p>CHAR(3)</p>
<p>MySQL服务器变量</p>
<p>作用域，分为两类：</p>
<p>全局变量</p>
<p>SHOW GLOBAL VARIABLES</p>
<p>会话变量<br>        SHOW [SESSION] VARIABLES</p>
<p>生效时间，分为两类：<br>    动态：可即时修改<br>    静态：<br>        写在配置文件中<br>        通过参数传递给mysqld</p>
<p>动态调整参数的生效方式：<br>    全局：对当前会话无效，只对新建立会话有效；<br>    会话：即时生效，但只对当前会话有效；</p>
<p>服务器变量：@@变量名<br>    显示：SELECT<br>    设定：SET GLOBAL|SESSION 变量名=’value’</p>
<p>/etc/my.cnf</p>
<p>~/.my.cnf</p>
<p>SQL语句：</p>
<p>数据库</p>
<p>表</p>
<p>索引</p>
<p>视图</p>
<p>DML</p>
<p>数据库：</p>
<p>CREATE DATABASE|SCHEMA [IF NOT EXISTS] db_name [CHARACTER SET=] [COLLATE=]</p>
<p>DROP {DATABASE | SCHEMA} [IF EXISTS] db_name</p>
<p>表：</p>
<p>1、直接定义一张空表；</p>
<p>2、从其它表中查询出数据，并以之创建新表；</p>
<p>3、以其它表为模板创建一个空表；</p>
<p>CREATE TABLE [IF NOT EXISTS] tb_name (col_name col_defination, constraint )</p>
<p>CREATE TABLE tb1 (id INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY, Name CHAR(20) NOT NULL, Age TINYINT NOT NULL) ENGINE [=] engine_name</p>
<p>CREATE TABLE tb2 (id INT UNSIGNED NOT NULL AUTO_INCREMENT, Name CHAR(20) NOT NULL, Age TINYINT NOT NULL, PRIMARY KEY(id),UNIQUE KEY(name),INDEX(age))</p>
<p>单字段：</p>
<p>PRIMARY KEY</p>
<p>UNIQUE KEY</p>
<p>单或多字段：</p>
<p>PRAMARY KEY (col,…)</p>
<p>UNIQUE KEY (col,…)</p>
<p>INDEX (col,…)</p>
<p>键也称作约束，可用作索引，属于特殊索引(有特殊限定)：B+Tree</p>
<p>CREATE INDEX创建索引</p>
<p>SHOW INDEXES FROM tb_name：显示指定表上的索引</p>
<p>修改表定义：</p>
<p>ALTER TABLE</p>
<p>添加、删除、修改字段</p>
<p>添加、删除、修改索引</p>
<p>改表名</p>
<p>修改表属性</p>
<p>删除表：</p>
<p>InnoDB支持外键</p>
<p>索引创建：</p>
<p>CREATE INDEX index_name ON tb_name (col,…);</p>
<p>col_name [(length)] [ASC | DESC]</p>
<p>name</p>
<p>11234</p>
<p>11567</p>
<p>DDL:</p>
<p>DML:</p>
<p>SELECT</p>
<p>INSERT INTO</p>
<p>DELETE</p>
<p>UPDATE</p>
<p>SELECT select-list FROM tb WHERE qualification</p>
<p>查询语句类型：</p>
<p>简单查询</p>
<p>多表查询</p>
<p>子查询</p>
<p>SELECT * FROM tb_name;</p>
<p>SELECT field1,field2 FROM tb_name; 投影</p>
<p>SELECT [DISTINCT] * FROM tb_name WHERE qualification; 选择</p>
<p>FROM子句： 要查询的关系 表、多个表、其它SELECT语句</p>
<p>WHERE子句：布尔关系表达式</p>
<p>=、&gt;、&gt;=、&lt;=、&lt;</p>
<p>逻辑关系：</p>
<p>AND</p>
<p>OR</p>
<p>NOT</p>
<p>BETWEEN … AND …<br>LIKE ‘’<br>    %: 任意长度任意字符<br>    _：任意单个字符<br>REGEXP, RLIKE<br>IN<br>IS NULL<br>IS NOT NULL</p>
<p>ORDER BY field_name {ASC|DESC}</p>
<p>字段别名：AS</p>
<p>LIMIT子句：LIMIT [offset,]Count</p>
<p>聚合：SUM(), MIN(), MAX(), AVG(), COUNT()</p>
<p>GROUP BY: 分组</p>
<p>HAVING qualification</p>
<p>多表查询：</p>
<p>连接：<br>    交叉连接：笛卡尔乘积<br>    自然连接：<br>    外连接：<br>        左外连接：… LEFT JOIN … ON …<br>        右外连接: … RIGHT JOIN … ON …<br>    自连接：</p>
<p>子查询：</p>
<p>比较操作中使用子查询：子查询只能返回单个值；</p>
<p>IN(): 使用子查询；</p>
<p>在FROM中使用子查询；</p>
<p>联合查询：</p>
<p>UNION</p>
<p>练习：</p>
<p>1、挑选出courses表中没有被students中的CID2学习的课程的课程名称；</p>
<p>附加：挑选出没有教授任何课程的老师，每个老师及其所教授课程的对应关系在courses表中；</p>
<p>找出students表中CID1有两个或两个以上同学学习了的同一个门课程的课程名称；</p>
<p>2、显示每一位老师及其所教授的课程；没有教授的课程的保持为NULL；</p>
<p>3、显示每一个课程及其相关的老师，没有老师教授的课程将其老师显示为空；</p>
<p>4、显示每位同学CID1课程的课程名及其讲授了相关课程的老师的名称；</p>
<p>5、</p>
<p>视图: 存储下来的SELECT语句；</p>
<p>基于基表的查询结果；</p>
<p>VIEW</p>
<p>CREATE VIEW</p>
<p>物化视图：SELECT</p>
<p>SHOW CREATE</p>
<p>RHCA：</p>
<p>python:</p>
<p>DDL:</p>
<p>SELECT:</p>
<p>选择：SELECT * FROM tb_name WHERE</p>
<p>布尔表达式</p>
<p>算术运算：</p>
<p>比较操作符：</p>
<p>其它运算符：IN, BETWEEN … AND …, LIKE, RLIKE(REGEXP), IS NULL, IS NOT NULL</p>
<p>逻辑运算：AND, OR, NOT, XOR</p>
<p>DISTINCT</p>
<p>投影：SELECT field1, … FROM tb_name;</p>
<p>ORDER BY field,… {ASC|DESC}</p>
<p>聚合计算：COUNT()、SUM()、MAX()、MIN()和AVG()；</p>
<p>GROUP BY field1,…</p>
<p>HAVING</p>
<p>LIMIT [offset],num</p>
<p>多表查询：</p>
<p>交叉连接</p>
<p>自然连接</p>
<p>WHERE tb1.field=tb2.field</p>
<p>外连接</p>
<p>左外</p>
<p>FROM tb1 LEFT JOIN tb2 ON condition</p>
<p>右外</p>
<p>FROM tb1 RIGHT JOIN tb2 ON condtion</p>
<p>自连接</p>
<p>子查询：</p>
<p>FROM</p>
<p>WHERE</p>
<p>比较操作符：子查询只能返回一个字段的单值；</p>
<p>IN：列表(某字段的多个值)</p>
<p>广义查询：</p>
<p>DML：</p>
<p>DELETE</p>
<p>INSERT INTO</p>
<p>UPDATE</p>
<p>INSERT INTO tb_name (col1, col2, …) VALUES (val1, val2, …)[,(val1, val2, …),…]</p>
<p>字符型：单引号</p>
<p>数值型：不需要引号</p>
<p>日期时间型：</p>
<p>空值：NULL， ‘’</p>
<p>REPLACE INTO</p>
<p>DELETE：</p>
<p>DELETE FROM tb_name WHERE condition;</p>
<p>TRUNCATE tb_name: 清空表，并重置AUTOINCREMENT计数器；</p>
<p>UPDATE tb_name SET col1=…, col2=… WHERE</p>
<p>连接管理器：</p>
<p>接受请求</p>
<p>创建线程</p>
<p>认证用户</p>
<p>建立安全连接</p>
<p>并发控制：</p>
<p>mbox：MDA</p>
<p>C/S： 100<br>    10分钟：<br>        多版本并发控制： MVCC</p>
<p>锁：</p>
<p>读锁：共享锁</p>
<p>写锁：独占锁</p>
<p>LOCK TABLES tb_name {READ|WRITE};</p>
<p>UNLOCK TABLES</p>
<p>锁粒度：从大到小，MySQL服务器仅支持表级锁，行锁需要由存储引擎完成；</p>
<p>表锁：</p>
<p>页锁：</p>
<p>行锁：</p>
<p>事务：</p>
<p>RDBMS: ACID (原子性，一致性，隔离性，持久性)</p>
<p>MyISAM:<br>InnoDB:</p>
<p>隔离性：</p>
<p>隔离级别：</p>
<p>READ UNCOMMITTED：读未提交</p>
<p>READ COMMITTED：读提交</p>
<p>REPATABLE READ：可重读</p>
<p>SERIABLIZABLE：可串行</p>
<p>服务器变量：</p>
<p>动态：</p>
<p>全局变量</p>
<p>修改后不影响当前会话，只对新建的会话有效；</p>
<p>会话变量</p>
<p>仅对当前会话有效，而且是立即生效；</p>
<p>永久有效：修改配置文件</p>
<p>修改：SET {SESSION|GLOBAL} VAR_NAME=‘’;</p>
<p>多事务同时执行：彼此之间互不影响的方式进行并行；</p>
<p>事务之间交互：</p>
<p>通过数据集</p>
<p>事务：CPU， I/O</p>
<p>RDBMS,</p>
<p>ACID:</p>
<p>Automicity：原子性，事务所引起的数据库操作，要么都完成，要么都不执行；</p>
<p>Consistency：一致性，A（3000）–&gt;B(2000)</p>
<p>1:A：3000–&gt;2500,</p>
<p>2: A+B: 4500,</p>
<p>Isolation: 隔离性</p>
<p>事务调度：事务之间影响最小</p>
<p>MVCC：多版本并发控制</p>
<p>Durability：一旦事务成功完成，系统必须保证任何故障都不会引起事务表示出不一致性；</p>
<p>1、事务提交之前就已经写出数据至持久性存储；</p>
<p>2、结合事务日志完成；</p>
<p>事务日志：顺序IO</p>
<p>数据文件：随机IO</p>
<p>事务的状态：<br>    活动的：active<br>    部分提交的：最后一条语句执行后<br>    失败的：<br>    中止的：<br>    提交的：</p>
<p>事务：并发执行</p>
<p>1、提高吞吐量和资源利用率</p>
<p>2、减少等待时间</p>
<p>事务调度：</p>
<p>可恢复调度；</p>
<p>无级联高度：</p>
<p>隔离级别：</p>
<p>READ UNCOMMITTED</p>
<p>READ COMMITTED</p>
<p>REPEATABLE READ</p>
<p>SERIALIZABLE</p>
<p>并发控制依赖的技术手段：</p>
<p>锁</p>
<p>时间戳</p>
<p>多版本和快照隔离</p>
<p>饿死：</p>
<p>死锁：</p>
<p>SQL，ODBC</p>
<p>START TANSACTION：启动</p>
<p>SQL</p>
<p>SQL</p>
<p>COMMIT： 提交</p>
<p>ROLLBACK: 回滚</p>
<p>如果没有明确启动事务：</p>
<p>autocommit：能实现自动提交，每一个操作都直接提交；</p>
<p>建议：明确使用事务，并且关闭自动提交；</p>
<p>保存点：SAVEPOINT sid</p>
<p>回滚至保存点：ROLLBACK TO sid</p>
<p>用户和权限管理</p>
<p>Information about account privileges is stored in the user, db, host, tables_priv, columns_priv, and procs_priv tables in the mysql database. The MySQL server reads the contents of these tables into memory when it starts and reloads them under the circumstances. Access-control decisions are based on the in-memory copies of the grant tables.</p>
<p>user: Contains user accounts, global privileges, and other non-privilege columns.</p>
<p>user: 用户帐号、全局权限</p>
<p>db: Contains database-level privileges.</p>
<p>db: 库级别权限</p>
<p>host: Obsolete.</p>
<p>host: 废弃</p>
<p>tables_priv: Contains table-level privileges.</p>
<p>表级别权限</p>
<p>columns_priv: Contains column-level privileges.</p>
<p>列级别权限</p>
<p>procs_priv: Contains stored procedure and function privileges.</p>
<p>存储过程和存储函数相关的权限</p>
<p>proxies_priv: Contains proxy-user privileges.</p>
<p>代理用户权限</p>
<p>There are several distinctions between the way user names and passwords are used by MySQL and the way they are used by your operating system:</p>
<p>User names, as used by MySQL for authentication purposes, have nothing to do with user names (login names) as used by Windows or Unix.<br>MySQL user names can be up to 16 characters long.<br>The server uses MySQL passwords stored in the user table to authenticate client connections using MySQL native authentication (against passwords stored in the mysql.user table).<br>MySQL encrypts passwords stored in the user table using its own algorithm. This encryption is the same as that implemented by the PASSWORD() SQL function but differs from that used during the Unix login process.<br>It is possible to connect to the server regardless of character set settings if the user name and password contain only ASCII characters.</p>
<p>用户帐号：</p>
<p>用户名@主机</p>
<p>用户名：16字符以内</p>
<p>主机：</p>
<p>主机名：<a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a>, mysql</p>
<p>IP: 172.16.10.177</p>
<p>网络地址:</p>
<p>172.16.0.0/255.255.0.0</p>
<p>通配符：%，_<br>            172.16.%.%<br>            %.magedu.com</p>
<p>–skip-name-resolve</p>
<p>权限级别：</p>
<p>全局级别： SUPER、</p>
<p>库</p>
<p>表: DELETE, ALTER, TRIGGER</p>
<p>列: SELECT, INSERT, UPDATE</p>
<p>存储过程和存储函数</p>
<p>字段级别：</p>
<p>临时表：内存表</p>
<p>heap: 16MB</p>
<p>触发器：主动数据库</p>
<p>INSERT, DELETE, UPDATE</p>
<p>user: log</p>
<p>CREATE USER usernamehost [IDENTIFIED BY ‘password’]</p>
<p>GRANT</p>
<p>GRANT ALL PRIVILEGES ON [object_type] db.* TO username@’%’;</p>
<p>TABLE</p>
<p>| FUNCTION</p>
<p>| PROCEDURE</p>
<p>GRANT EXECUTE ON FUNCTION db.abc TO username@’%’;</p>
<p>INSERT INTO mysql.user</p>
<p>mysql&gt; FLUSH PRIVILEGES;</p>
<p>SHOW GRANTS FOR ‘username@host’;</p>
<p>GRANT OPTION</p>
<p>| MAX_QUERIES_PER_HOUR count</p>
<p>| MAX_UPDATES_PER_HOUR count</p>
<p>| MAX_CONNECTIONS_PER_HOUR count</p>
<p>| MAX_USER_CONNECTIONS count</p>
<p>–skip-grant-tables</p>
<p>–skip-name-resolve</p>
<p>DROP USER ‘username’@’host’</p>
<p>RENAME USER old_name TO new_name</p>
<p>REVOKE</p>
<p>启动mysqld_safe时传递两个参数：</p>
<p>–skip-grant-tables</p>
<p>–skip-networking</p>
<p>通过更新授权表方式直接修改其密码，而后移除此两个选项重启服务器。</p>
<p>错误日志</p>
<p>log_error</p>
<p>log_warnings</p>
<p>一般查询日志：</p>
<p>general_log</p>
<p>general_log_file</p>
<p>log</p>
<p>log_output</p>
<p>慢查询日志</p>
<p>long_query_time</p>
<p>log_slow_queries={YES|NO}</p>
<p>slow_query_log</p>
<p>| slow_query_log_file</p>
<p>二进制日志：任何引起或可能引起数据库变化的操作；</p>
<p>复制、即时点恢复；</p>
<p>mysqlbinlog</p>
<p>二进制日志的格式：<br>    基于语句: statement<br>    基于行: row<br>    混合方式: mixed</p>
<p>二进制日志事件：<br>    产生的时间<br>    相对位置</p>
<p>二进制日志文件：<br>    索引文件<br>    二进制日志文件</p>
<p>查看当前正在使用的二进制日志文件<br>mysql&gt; SHOW MASTER STATUS;</p>
<p>mysql&gt; SHOW BINARY LOGS; </p>
<p>mysql&gt; SHOW BINLOG EVENTS IN ‘二进制日志文件名’ [FROM pos]；</p>
<p>mysql&gt; PURGE BINARY LOGS TO ‘某二进制日志文件’</p>
<p>mysqlbinlog<br>    –start-datetime<br>    –stop-datetime</p>
<pre><code>--start-position
--stop-position</code></pre><p>中继日志</p>
<p>事务日志：ACID，将随机IO转换为顺序IO；</p>
<p>知识回顾：</p>
<p>用户及权限管理：</p>
<p>‘username’@’host’</p>
<p>password()</p>
<p>–skip-grant-tables –skip-networking<br>UPDATE mysql.user</p>
<p>权限：<br>    服务管理类：super<br>    库: CREATE<br>    表: DELETE、ALTER<br>    列: INSERT, SELECT, UPDATE</p>
<p>GRANT 权限,… ON [对象类型] db.{table|routine} TO ‘username’@’host’ [IDENTIFIED BY ‘password’];<br>REVOKE 权限,… ON [对象类型] db.{table|routine} FROM ‘username’@’host’;<br>SHOW GRANTS FOR ‘username’@’host’;<br>CREATE USER ‘username’@’host’ [IDENTIFIED BY ‘password’];<br>DROP USER ‘username’@’host’;<br>RENAME USER old_name TO new_name;</p>
<p>日志:</p>
<p>错误日志：</p>
<p>一般查询日志：</p>
<p>慢查询日志：</p>
<p>log_output {TABLE|FILE|NONE}</p>
<p>二进制日志:</p>
<p>复制、即时点恢复</p>
<p>二进制日志事件：</p>
<p>基于语句：statement</p>
<p>基于行：row</p>
<p>混合方式：mixed</p>
<p>mysql&gt; SHOW BINARY LOGS;<br>    mysql&gt; SHOW MASTER STATUS;<br>    mysql&gt; SHOW BINLOG EVENTS IN ‘二进制日志文件’ FROM ‘position’;<br>    mysql&gt; PURGE BINARY LOGS TO ‘日志文件’;<br>    mysql&gt; FLUSH LOGS;</p>
<p>mysqlbinlog<br>    –start-position<br>    –stop-position</p>
<pre><code>--start-datetime &apos;yyyy-mm-dd hh:mm:ss&apos;
--stop-datetime &apos;&apos;；</code></pre><p>中继日志：<br>    从主服务器的二进制日志文件中复制而来的事件，并保存为的日志文件；<br>事务日志：<br>    事务性存储引擎用于保证原子性、一致性、隔离性和持久性；<br>    innodb_flush_log_at_trx_commit:<br>        0: 每秒同步，并执行磁盘flush操作；<br>        1：每事务同步，并执行磁盘flush操作；<br>        2: 每事务同步，但不执行磁盘flush操作；</p>
<p>MyISAM:</p>
<p>不支持事务</p>
<p>表锁</p>
<p>不支持外键</p>
<p>B树索引、FULLTEXT索引、空间索引</p>
<p>支持表压缩</p>
<p>.frm</p>
<p>.MYD</p>
<p>.MYI</p>
<p>InnoDB:</p>
<p>事务</p>
<p>行级锁</p>
<p>B树索引、聚簇索引、自适应hash索引</p>
<p>表空间，raw磁盘设备；</p>
<p>.frm</p>
<p>.ibd</p>
<p>MRG_MYISAM：</p>
<p>表类型：</p>
<p>MySQL的备份和还原</p>
<p>备份：副本<br>RAID1，RAID10：保证硬件损坏而不会业务中止；<br>    DROP TABLE mydb.tb1;</p>
<p>备份类型：<br>    热备份、温备份和冷备份<br>        热备份：读、写不受影响；<br>        温备份：仅可以执行读操作；<br>        冷备份：离线备份；读、写操作均中止；</p>
<pre><code>物理备份和逻辑备份
    物理备份：复制数据文件；
    逻辑备份：将数据导出至文本文件中；

完全备份、增量备份和差异备份；
    完全备份：备份全部数据；
    增量备份：仅备份上次完全备份或增量备份以后变化的数据；
    差异备份：仅备份上次完全备份以来变化的数据；</code></pre><p>在线：物理完全备份</p>
<p>还原：</p>
<p>备份什么：<br>        数据、配置文件、二进制日志、事务日志</p>
<p>热备份：</p>
<p>MyISAM: 温备份</p>
<p>InnoDB: xtrabackup, mysqldump</p>
<p>MySQL –&gt; 从：</p>
<p>物理备份：速度快</p>
<p>逻辑备份：速度慢、丢失浮点数精度；方便使用文本处理工具直接对其处理、可移植能力强；</p>
<p>备份策略：完全+增量；完全+差异</p>
<p>MySQL备份工具：</p>
<p>mysqldump: 逻辑备份工具、MyISAM(温)、InnoDB(热备份)</p>
<p>mysqlhotcopy：物理备份工具、温备份</p>
<p>文件系统工具：</p>
<p>cp：冷备</p>
<p>lv: 逻辑卷的快照功能，几乎热备；</p>
<p>mysql&gt; FLUSH TABLES;</p>
<p>mysql&gt; LOCK TABLES</p>
<p>创建快照：释放锁，而后复制数据</p>
<p>InnoDB:</p>
<p>第三组工具：</p>
<p>ibbackup: 商业工具</p>
<p>xtrabackup: 开源工具</p>
<p>mysqldump: 逻辑备份</p>
<p>mysqldump（完全备份）+ 二进制日志</p>
<p>完全+增量：</p>
<p>备份单个数据库，或库中特定表</p>
<p>mysqldump DB_NAME [tb1] [tb2]</p>
<p>–master-data={0|1|2}</p>
<p>0: 不记录二进制日志文件及路位置；</p>
<p>1：以CHNAGE MASTER TO的方式记录位置，可用于恢复后直接启动从服务器；</p>
<p>2：以CHANGE MASTER TO的方式记录位置，但默认为被注释；</p>
<p>–lock-all-tables：锁定所有表</p>
<p>–flush-logs: 执行日志flush；</p>
<p>如果指定库中的表类型均为InnoDB，可使用–single-transaction启动热备；</p>
<p>备份多个库：</p>
<p>–all-databases: 备份所有库</p>
<p>–databases DB_NAME,DB_NAME,…: 备份指定库</p>
<p>–events<br>–routines<br>–triggers</p>
<p>备份策略：每周完全+每日增量</p>
<p>完全备份：mysqldump</p>
<p>增量备份：备份二进制日志文件(flush logs)</p>
<p>expire_logs_days={0..99}</p>
<p>设定二进制日志的过期天数，超出此天数的二进制日志文件将被自动删除。默认为0，表示不启用过期自动删除功能。如果启用此功能，自动删除工作通常发生在MySQL启动时或FLUSH日志时。作用范围为全局，可用于配置文件，属动态变量。</p>
<p>general_log={ON|OFF}</p>
<p>设定是否启用查询日志，默认值为取决于在启动mysqld时是否使用了–general_log选项。如若启用此项，其输出位置则由–log_output选项进行定义，如果log_output的值设定为NONE，即使用启用查询日志，其也不会记录任何日志信息。作用范围为全局，可用于配置文件，属动态变量。</p>
<p>general_log_file=FILE_NAME</p>
<p>查询日志的日志文件名称，默认为“hostname.log”。作用范围为全局，可用于配置文件，属动态变量。</p>
<p>binlog-format={ROW|STATEMENT|MIXED}</p>
<p>指定二进制日志的类型，默认为STATEMENT。如果设定了二进制日志的格式，却没有启用二进制日志，则MySQL启动时会产生警告日志信息并记录于错误日志中。作用范围为全局或会话，可用于配置文件，且属于动态变量。</p>
<p>log={YES|NO}</p>
<p>是否启用记录所有语句的日志信息于一般查询日志(general query log)中，默认通常为OFF。MySQL 5.6已经弃用此选项。</p>
<p>log-bin={YES|NO}</p>
<p>是否启用二进制日志，如果为mysqld设定了–log-bin选项，则其值为ON，否则则为OFF。其仅用于显示是否启用了二进制日志，并不反应log-bin的设定值。作用范围为全局级别，属非动态变量。</p>
<p>log_bin_trust_function_creators={TRUE|FALSE}</p>
<p>此参数仅在启用二进制日志时有效，用于控制创建存储函数时如果会导致不安全的事件记录二进制日志条件下是否禁止创建存储函数。默认值为0，表示除非用户除了CREATE ROUTING或ALTER ROUTINE权限外还有SUPER权限，否则将禁止创建或修改存储函数，同时，还要求在创建函数时必需为之使用DETERMINISTIC属性，再不然就是附带READS SQL DATA或NO SQL属性。设置其值为1时则不启用这些限制。作用范围为全局级别，可用于配置文件，属动态变量。</p>
<p>log_error=/PATH/TO/ERROR_LOG_FILENAME</p>
<p>定义错误日志文件。作用范围为全局或会话级别，可用于配置文件，属非动态变量。</p>
<p>log_output={TABLE|FILE|NONE}</p>
<p>定义一般查询日志和慢查询日志的保存方式，可以是TABLE、FILE、NONE，也可以是TABLE及FILE的组合(用逗号隔开)，默认为TABLE。如果组合中出现了NONE，那么其它设定都将失效，同时，无论是否启用日志功能，也不会记录任何相关的日志信息。作用范围为全局级别，可用于配置文件，属动态变量。</p>
<p>log_query_not_using_indexes={ON|OFF}</p>
<p>设定是否将没有使用索引的查询操作记录到慢查询日志。作用范围为全局级别，可用于配置文件，属动态变量。</p>
<p>log_slave_updates</p>
<p>用于设定复制场景中的从服务器是否将从主服务器收到的更新操作记录进本机的二进制日志中。本参数设定的生效需要在从服务器上启用二进制日志功能。</p>
<p>log_slow_queries={YES|NO}</p>
<p>是否记录慢查询日志。慢查询是指查询的执行时间超出long_query_time参数所设定时长的事件。MySQL 5.6将此参数修改为了slow_query_log。作用范围为全局级别，可用于配置文件，属动态变量。</p>
<p>log_warnings=#</p>
<p>设定是否将警告信息记录进错误日志。默认设定为1，表示启用；可以将其设置为0以禁用；而其值为大于1的数值时表示将新发起连接时产生的“失败的连接”和“拒绝访问”类的错误信息也记录进错误日志。</p>
<p>long_query_time=#</p>
<p>设定区别慢查询与一般查询的语句执行时间长度。这里的语句执行时长为实际的执行时间，而非在CPU上的执行时长，因此，负载较重的服务器上更容易产生慢查询。其最小值为0，默认值为10，单位是秒钟。它也支持毫秒级的解析度。作用范围为全局或会话级别，可用于配置文件，属动态变量。</p>
<p>max_binlog_cache_size{4096 .. 18446744073709547520}</p>
<p>二进定日志缓存空间大小，5.5.9及以后的版本仅应用于事务缓存，其上限由max_binlog_stmt_cache_size决定。作用范围为全局级别，可用于配置文件，属动态变量。</p>
<p>max_binlog_size={4096 .. 1073741824}</p>
<p>设定二进制日志文件上限，单位为字节，最小值为4K，最大值为1G，默认为1G。某事务所产生的日志信息只能写入一个二进制日志文件，因此，实际上的二进制日志文件可能大于这个指定的上限。作用范围为全局级别，可用于配置文件，属动态变量。</p>
<p>max_relay_log_size={4096..1073741824}</p>
<p>设定从服务器上中继日志的体积上限，到达此限度时其会自动进行中继日志滚动。此参数值为0时，mysqld将使用max_binlog_size参数同时为二进制日志和中继日志设定日志文件体积上限。作用范围为全局级别，可用于配置文件，属动态变量。</p>
<p>innodb_log_buffer_size={262144 .. 4294967295}</p>
<p>设定InnoDB用于辅助完成日志文件写操作的日志缓冲区大小，单位是字节，默认为8MB。较大的事务可以借助于更大的日志缓冲区来避免在事务完成之前将日志缓冲区的数据写入日志文件，以减少I/O操作进而提升系统性能。因此，在有着较大事务的应用场景中，建议为此变量设定一个更大的值。作用范围为全局级别，可用于选项文件，属非动态变量。</p>
<p>innodb_log_file_size={108576 .. 4294967295}</p>
<p>设定日志组中每个日志文件的大小，单位是字节，默认值是5MB。较为明智的取值范围是从1MB到缓存池体积的1/n，其中n表示日志组中日志文件的个数。日志文件越大，在缓存池中需要执行的检查点刷写操作就越少，这意味着所需的I/O操作也就越少，然而这也会导致较慢的故障恢复速度。作用范围为全局级别，可用于选项文件，属非动态变量。</p>
<p>innodb_log_files_in_group={2 .. 100}</p>
<p>设定日志组中日志文件的个数。InnoDB以循环的方式使用这些日志文件。默认值为2。作用范围为全局级别，可用于选项文件，属非动态变量。</p>
<p>innodb_log_group_home_dir=/PATH/TO/DIR</p>
<p>设定InnoDB重做日志文件的存储目录。在缺省使用InnoDB日志相关的所有变量时，其默认会在数据目录中创建两个大小为5MB的名为ib_logfile0和ib_logfile1的日志文件。作用范围为全局级别，可用于选项文件，属非动态变量。</p>
<p>relay_log=file_name</p>
<p>设定中继日志的文件名称，默认为host_name-relay-bin。也可以使用绝对路径，以指定非数据目录来存储中继日志。作用范围为全局级别，可用于选项文件，属非动态变量。</p>
<p>relay_log_index=file_name</p>
<p>设定中继日志的索引文件名，默认为为数据目录中的host_name-relay-bin.index。作用范围为全局级别，可用于选项文件，属非动态变量。</p>
<p>relay-log-info-file=file_name</p>
<p>设定中继服务用于记录中继信息的文件，默认为数据目录中的relay-log.info。作用范围为全局级别，可用于选项文件，属非动态变量。</p>
<p>relay_log_purge={ON|OFF}</p>
<p>设定对不再需要的中继日志是否自动进行清理。默认值为ON。作用范围为全局级别，可用于选项文件，属动态变量。</p>
<p>relay_log_space_limit=#</p>
<p>设定用于存储所有中继日志文件的可用空间大小。默认为0，表示不限定。最大值取决于系统平台位数。作用范围为全局级别，可用于选项文件，属非动态变量。</p>
<p>slow_query_log={ON|OFF}</p>
<p>设定是否启用慢查询日志。0或OFF表示禁用，1或ON表示启用。日志信息的输出位置取决于log_output变量的定义，如果其值为NONE，则即便slow_query_log为ON，也不会记录任何慢查询信息。作用范围为全局级别，可用于选项文件，属动态变量。</p>
<p>slow_query_log_file=/PATH/TO/SOMEFILE</p>
<p>设定慢查询日志文件的名称。默认为hostname-slow.log，但可以通过–slow_query_log_file选项修改。作用范围为全局级别，可用于选项文件，属动态变量。</p>
<p>sql_log_bin={ON|OFF}</p>
<p>用于控制二进制日志信息是否记录进日志文件。默认为ON，表示启用记录功能。用户可以在会话级别修改此变量的值，但其必须具有SUPER权限。作用范围为全局和会话级别，属动态变量。</p>
<p>sql_log_off={ON|OFF}</p>
<p>用于控制是否禁止将一般查询日志类信息记录进查询日志文件。默认为OFF，表示不禁止记录功能。用户可以在会话级别修改此变量的值，但其必须具有SUPER权限。作用范围为全局和会话级别，属动态变量。</p>
<p>sync_binlog=#</p>
<p>设定多久同步一次二进制日志至磁盘文件中，0表示不同步，任何正数值都表示对二进制每多少次写操作之后同步一次。当autocommit的值为1时，每条语句的执行都会引起二进制日志同步，否则，每个事务的提交会引起二进制日志同步。</p>
<p>知识回顾：</p>
<p>1、hot(r/w)、warm(r)、cold</p>
<p>2、logical, raw</p>
<p>mysql:</p>
<p>raw:</p>
<p>3、备份数据集</p>
<p>full</p>
<p>incremental</p>
<p>differential</p>
<p>二进制日志：</p>
<p>format:</p>
<p>statment</p>
<p>row</p>
<p>mixed</p>
<p>mysqldump:</p>
<p>–databases DB1,DB2,…</p>
<p>–all-databases</p>
<p>MyISAM: 温备份</p>
<p>–lock-all-tables</p>
<p>–lock-tables</p>
<p>InnoDB: 热备份</p>
<p>–single-transaction</p>
<p>–flush-logs</p>
<p>–events<br>–routines<br>–triggers</p>
<p>–master-data={0|1|2}</p>
<p>逻辑备份：</p>
<p>1、浮点数据丢失精度；</p>
<p>2、备份出的数据更占用存储空间；压缩后可大大节省空间；</p>
<p>3、不适合对大数据库做完全备份；</p>
<p>对InnoDB:</p>
<p>mysql&gt; FLUSH TABLES WITH READ LOCK;</p>
<p>MVCC, REPEATABLE-READ</p>
<p>–single-transaction</p>
<p>备份：</p>
<p>SELECT * INTO OUTFILE ‘/path/to/somefile.txt’ FROM tb_name [WHERE clause];</p>
<p>还原：</p>
<p>LOAD DATA INFILE ‘/path/to/somefile.txt’ INTO TABLE tb_name;</p>
<p>几乎热备：LVM</p>
<p>snapshot:</p>
<p>前提：<br>    1、数据文件要在逻辑卷上；<br>    2、此逻辑卷所在卷组必须有足够空间使用快照卷；<br>    3、数据文件和事务日志要在同一个逻辑卷上；</p>
<p>步骤：<br>    1、打开会话，施加读锁，锁定所有表；<br>        mysql&gt; FLUSH TABLES WITH READ LOCK;<br>        mysql&gt; FLUSH LOGS;<br>    2、通过另一个终端，保存二进制日志文件及相关位置信息；<br>        $ mysql -uroot -p -e ‘SHOW MASTER STATUS\G’ &gt; /path/to/master.info<br>    3、创建快照卷<br>        # lvcreate -L # -s -p r -n LV_NAME /path/to/source_lv<br>    4、释放锁<br>        mysql&gt; UNLOCK TABLES;<br>    5、挂载快照卷，备份<br>        mount<br>        cp<br>    6、删除快照卷；<br>    7、增量备份二进制日志；</p>
<p>二进制日志相关的几个选项：</p>
<p>innodb_support_xa={TRUE|FLASE}</p>
<p>存储引擎事务在存储引擎内部被赋予了ACID属性，分布式(XA)事务是一种高层次的事务，它利用“准备”然后“提交”(prepare-then-commit)两段式的方式将ACID属性扩展到存储引擎外部，甚至是数据库外部。然而，“准备”阶段会导致额外的磁盘刷写操作。XA需要事务协调员，它会通知所有的参与者准备提交事务(阶段1)。当协调员从所有参与者那里收到“就绪”信息时，它会指示所有参与者进行真正的“提交”操作。</p>
<p>此变量正是用于定义InnoDB是否支持两段式提交的分布式事务，默认为启用。事实上，所有启用了二进制日志的并支持多个线程同时向二进制日志写入数据的MySQL服务器都需要启用分布式事务，否则，多个线程对二进制日志的写入操作可能会以与原始次序不同的方式完成，这将会在基于二进制日志的恢复操作中或者是从服务器上创建出不同原始数据的结果。因此，除了仅有一个线程可以改变数据以外的其它应用场景都不应该禁用此功能。而在仅有一个线程可以修改数据的应用中，禁用此功能是安全的并可以提升InnoDB表的性能。作用范围为全局和会话级别，可用于选项文件，属动态变量。</p>
<p>sync_binlog = 1</p>
<p>mysql&gt; LOCK TABLES mydb.tb1 READ, mydb.tb2 READ, …</p>
<p>mysql&gt; FLUSH TABLES mydb.tb1, mydb.tb2, …</p>
<p>mysq&gt; SET SQL_LOG_BIN=0;</p>
<p>mysql&gt; SOURCE somefile.sql;</p>
<p>mysql&gt; SET SQL_LOG_BIN=1;</p>
<p>percona:</p>
<p>ibbackup: InnoDB online physical backup</p>
<p>full</p>
<p>incremental</p>
<p>MyISAM: warm backup, full</p>
<p>$5000</p>
<p>mysqldump</p>
<p>LVM –&gt; mylvmbackup(perl scripts)</p>
<p>percona:</p>
<p>xtrabackup</p>
<p>xtradb: innodb的增强版</p>
<p>innodb</p>
<p>xtrabackup+二进制日志；</p>
<p>mysql:</p>
<p>二进制日志</p>
<p>事务日志</p>
<p>错误日志</p>
<p>一般查询日志</p>
<p>中继日志</p>
<p>慢查询日志</p>
<p>二进制日志：</p>
<p>数据目录</p>
<p>mysql-bin.XXXXXX</p>
<p>滚动：达到最大上限，flush logs，服务器重启</p>
<p>mysql&gt; PURGE</p>
<p>二进制日志的格式：<br>    statement<br>    row<br>    mixed</p>
<p>mysql-bin.index: 二进制日志文件索引文件</p>
<p>mysql&gt; SHOW MASTER STATUS;<br>mysql&gt; SHOW BINARY LOGS;<br>mysql&gt; SHOW BINLOG EVENTS IN “file”;</p>
<p>event:<br>    timestamp<br>    position, offset，OPERATION, server-id</p>
<p>即时点还原：</p>
<p>MySQL: tx1</p>
<p>MySQL隔离级别：<br>    READ-UNCOMMITTED<br>    READ-COMMITTED<br>    REPEATABLE-READ<br>    SERIALIZABLE</p>
<p>复制的作用：</p>
<p>辅助实现备份</p>
<p>高可用</p>
<p>异地容灾</p>
<p>scale out：分摊负载</p>
<p>主从架构中，不使用MySQL代理，如何让主的负责写，从的负责读？</p>
<p>双主：无法减轻写操作；</p>
<p>双主模型：</p>
<p>tutors: name, age, gender, tid</p>
<p>tom 10</p>
<p>jerry 30</p>
<p>A: UPDATE tutors SET name=Jerry where age=10 ;</p>
<p>B: UPDATE tutors SET age=30 WHERE name=tom;</p>
<p>tid:</p>
<p>1</p>
<p>3</p>
<p>5</p>
<p>7</p>
<p>9</p>
<p>11</p>
<p>2</p>
<p>4</p>
<p>读写分离：</p>
<p>mysql-proxy</p>
<p>amoeba</p>
<p>数据拆分：</p>
<p>cobar:</p>
<p>master: slave</p>
<p>1–&gt;N</p>
<p>slave: master</p>
<p>1–&gt;N X</p>
<p>一个从只能属于一个主服务器</p>
<p>MySQL 5.5:</p>
<p>MySQL 5.6: gtid, multi-thread replication</p>
<p>配置MySQL复制基本步骤：</p>
<p>一、master</p>
<p>1、启用二进制日志</p>
<p>log-bin = master-bin</p>
<p>log-bin-index = master-bin.index</p>
<p>2、选择一个惟一server-id</p>
<p>server-id = {0-2^32}</p>
<p>3、创建具有复制权限的用户</p>
<p>REPLICATION SLAVE</p>
<p>REPLICATION CLIENT</p>
<p>二、slave</p>
<p>1、启用中继日志</p>
<p>relay-log = relay-log</p>
<p>relay-log-index =</p>
<p>2、选择一个惟一的server-id</p>
<p>server-id = {0-2^32}</p>
<p>3、连接至主服务器，并开始复制数据；</p>
<p>mysql&gt; CHANGER MASTER TO MASTER_HOST=’’,MASTER_PORT=’’,MASTER_LOG_FILE=’’,MASTER_LOG_FIEL_POS=’’,MASTER_USER=’’,MASTER_PASSWORD=’’;</p>
<p>mysql&gt; START SLAVE;</p>
<p>mysql&gt; START SLAVE IO_Thread;<br>mysql&gt; START SLAVE SQL_Thread;</p>
<p>复制线程：</p>
<p>master: dump</p>
<p>slave: IO_Thread, SQL_Thread</p>
<p>read-only = YES</p>
<p>在从服务器上设定，但对具有SUPER权限的用户不生效；</p>
<p>sync-binlog = ON</p>
<p>在主服务器上设定，用于事务安全；</p>
<p>percona: percona-tools</p>
<p>mattkit-tools</p>
<p>SSL:</p>
<p>Dual MASTER:</p>
<p>1、从服务器能不能执行“写”操作？</p>
<p>CREATE</p>
<p>INSERT</p>
<p>如何阻止写从服务器？</p>
<p>my.cnf</p>
<p>[mysqld]</p>
<p>read-only = 1</p>
<p>不能阻止 SQL Thread</p>
<p>如果某用户有SUPER权限，则不被阻止；</p>
<p>mysql&gt; FLUSH TABLES WITH READ LOCK;</p>
<p>2、一个主服务器可否多从？可以</p>
<p>一从是否多主？不行</p>
<p>3、主–&gt;从：异步</p>
<p>mysql 5.5 google 补丁</p>
<p>半同步： semisync</p>
<p>半同步如果无法在指定时间完成–&gt;自动 降到异步模式；</p>
<p>4、如何从服务器的mysql服务在启动时候不要自动启动从服务线程？</p>
<p>master.info</p>
<p>relay-log.info</p>
<p>在从服务器上：</p>
<p>[mysqld]</p>
<p>skip-slave-start=1</p>
<p>5、数据库复制过滤</p>
<p>在主服务器上实现：</p>
<p>binlog-do-db=testdb</p>
<p>binlog-do-db=mydb</p>
<p>binlog-ignore-db=mysql</p>
<p>主服务器</p>
<p>[mysqld]</p>
<p>binlog-do-db=</p>
<p>OR</p>
<p>binlog-ignore-db=</p>
<p>在主服务器过滤：任何不涉及到数据库相关的写操作都不会被记录到二进制日志当中；</p>
<p>从服务器：</p>
<p>replicate_do_db</p>
<p>rpplicate_ignore_db</p>
<p>replicate_do_table</p>
<p>replicate_ignore_table</p>
<p>replicate_wild_do_table</p>
<p>replicate_wild_ignore_table</p>
<p>在从服务器上只复制mageedu一个数据库：</p>
<p>[mysqld]</p>
<p>replicate_do_db=mageedu</p>
<p>replicate_do_db=mysql</p>
<p>设置半同步步骤：</p>
<p>在Master和Slave的mysql命令行运行如下代码：</p>
<p>On Master</p>
<p>mysql&gt; INSTALL PLUGIN rpl_semi_sync_master SONAME ‘semisync_master.so’;</p>
<p>mysql&gt; SET GLOBAL rpl_semi_sync_master_enabled = 1;</p>
<p>mysql&gt; SET GLOBAL rpl_semi_sync_master_timeout = 1000;</p>
<p>On Slave</p>
<p>mysql&gt; INSTALL PLUGIN rpl_semi_sync_slave SONAME ‘semisync_slave.so’;</p>
<p>mysql&gt; SET GLOBAL rpl_semi_sync_slave_enabled = 1;</p>
<p>mysql&gt; STOP SLAVE IO_THREAD; START SLAVE IO_THREAD;</p>
<p>在Master和Slave的my.cnf中编辑：</p>
<p>On Master</p>
<p>[mysqld]</p>
<p>rpl_semi_sync_master_enabled=1</p>
<p>rpl_semi_sync_master_timeout=1000 # 1 second</p>
<p>On Slave</p>
<p>[mysqld]</p>
<p>rpl_semi_sync_slave_enabled=1</p>
<p>也可通过设置全局变量的方式来设置,如下：</p>
<p>set global rpl_semi_sync_master_enabled=1</p>
<p>取消加载插件</p>
<p>mysql&gt; UNINSTALL PLUGIN rpl_semi_sync_master;</p>
<p>查看从服务器上的semi_sync是否开启:</p>
<p>mysql&gt; SHOW GLOBAL STATUS LIKE ‘rpl_semi%’;</p>
<p>查看主服务器上的semi_sync是否开启，注意clients 变为1 ，证明主从半同步复制连接成功:</p>
<p>mysql&gt; SHOW GLOBAL STATUS LIKE ‘rpl_semi%’;</p>
<p>6、主服务器崩溃，事务已经提交–&gt;写入二进制日志；</p>
<p>在主-从架构上建议使用的配置：</p>
<p>主服务器：</p>
<p>sync_binlog=1</p>
<p>innodb_flush_logs_at_trx_commit=1</p>
<p>从服务器：</p>
<p>skip_slave_start=1</p>
<p>read_only=1</p>
<p>SSL:</p>
<p>REQURIED SSL</p>
<p>auto_increment</p>
<p>1,3,5</p>
<p>2,4,8</p>
<p>设置主-主复制：</p>
<p>1、在两台服务器上各自建立一个具有复制权限的用户；</p>
<p>2、修改配置文件：</p>
<p>主服务器上</p>
<p>[mysqld]</p>
<p>server-id = 10</p>
<p>log-bin = mysql-bin</p>
<p>relay-log = relay-mysql</p>
<p>relay-log-index = relay-mysql.index</p>
<p>auto-increment-increment = 2</p>
<p>auto-increment-offset = 1</p>
<p>从服务器上</p>
<p>[mysqld]</p>
<p>server-id = 20</p>
<p>log-bin = mysql-bin</p>
<p>relay-log = relay-mysql</p>
<p>relay-log-index = relay-mysql.index</p>
<p>auto-increment-increment = 2</p>
<p>auto-increment-offset = 2</p>
<p>3、如果此时两台服务器均为新建立，且无其它写入操作，各服务器只需记录当前自己二进制日志文件及事件位置，以之作为另外的服务器复制起始位置即可</p>
<p>server1|mysql&gt; SHOW MASTER STATUS\G</p>
<ol>
<li>row *</li>
</ol>
<p>File: mysql-bin.000001</p>
<p>Position: 710</p>
<p>Binlog_Do_DB:</p>
<p>Binlog_Ignore_DB:</p>
<p>1 row in set (0.00 sec)</p>
<p>server2|mysql&gt; SHOW MASTER STATUS\G</p>
<p>mysql&gt; SHOW MASTER STATUS\G</p>
<ol>
<li>row</li>
</ol>
<p>File: mysql-bin.000003</p>
<p>Position: 811</p>
<p>Binlog_Do_DB:</p>
<p>Binlog_Ignore_DB:</p>
<p>1 row in set (0.00 sec)</p>
<p>4、各服务器接下来指定对另一台服务器为自己的主服务器即可：</p>
<p>server1|mysql&gt; CHANGE MASTER TO …,MASTER_LOG_FILE=’mysql-bin.000003’, MASTER_LOG_POS=811</p>
<p>server2|mysql&gt; CHANGE MASTER TO …,MASTER_LOG_FILE=’mysql-bin.000001’, MASTER_LOG_POS=710</p>
<p>A: 查看B的二进制日志文件及位置，并以及作为自己的复制起点；</p>
<p>B：</p>
<p>配置主从复制的基本步骤：</p>
<p>1、master</p>
<p>启用二进制日志、惟一server-id、具有复制权限的用户(REQUIRE SSL)；</p>
<p>2、slave</p>
<p>启用中继日志、惟一server-id、连接主服务器并启动复制线程(IO_THREAD, SQL_THREAD)；</p>
<p>MySQL读写分离：</p>
<p>master: 写</p>
<p>slave: 只读</p>
<p>mysql-proxy、amoeba</p>
<p>cobar：</p>
<p>php –&gt; MySQL</p>
<p>LAMP: php语言开发的应用程序</p>
<p>blackhole: 存储引擎，多级复制时，</p>
<p>memcached: 缓存服务器</p>
<p>key: value</p>
<p>O(1)</p>
<p>MySQL: semisync_master.so, semisync_slave.so</p>
<p>写博客：</p>
<p>MySQL主从复制原理、主从复制、半同步复制、基于SSL复制或主主复制；</p>
<p>MySQL-5.6主从复制；(GTID, 多线程复制);</p>
<p>MySQL-proxy实现读写分离；</p>
<p>MySQL: 数据库复制过滤</p>
<p>MySQL-5.6: GTID</p>
<p>slave-parallel-workers=0</p>
<p>0: 表示禁用多线程功能；</p>
<p>/etc/mysql.cnf</p>
<p>[mysql-proxy]</p>
<p>主索引：包含记录的文件按某个搜索码指定的顺序进行排序，此索引即为主索引(primary index)，也称为聚集索引(clustering index)。</p>
<p>搜索码指定的顺序与文件中记录的物理顺序不同的索引称为辅助索引(secondary index)，或者非聚集索引(non-clustering index)。</p>
<p>静态散列：</p>
<p>桶：表示能存储一条或多条记录的一个存储单位。通常一个桶就是一个磁盘块，但也可能小于或大于一个磁盘块。令K表示所有搜索码的集合，令B为所有桶地址的集合，散列函数h是一个从K到B的函数。为了插入一条搜索码为k的记录，通过计算h(k)，可得出存储该记录的桶的地址。</p>
<p>桶溢出：发生的原因(1、桶不足；2、偏斜)</p>
<p>动态散列：</p>
<p>有多种实现技术，其中之一即为可扩充散列，它能够通过桶的分裂或合并来适应数据库大小的变化。</p>
<p>查询代价的度量：</p>
<p>传送磁盘块数和搜索磁盘块数；</p>
<p>查询处理：语法分析与翻译–&gt;优化–&gt;执行</p>
<p>选择运算：</p>
<p>线性搜索：全表扫描，是存取数据的最低级操作；它涉及一次初始搜索，及包含记录的文件的所有块传输；</p>
<p>B+树主索引，码属性等值比较：索引查找穿越树的高度，再加上一次IO来取记录；</p>
<p>B+树主索引，非码属性等会比较：树的每一次一次搜索，第一个块一次搜索；</p>
<p>B+树辅助索引，码属性等值比较；</p>
<p>B+树辅助索引，非码属性等值比较；每条记录可能在不同的块上，这需要每条记录一次搜索；</p>
<p>B+树主索引，比较：对于A&gt;=v，在索引中找到第一个满足条件A=v的记录，而后依次读取其后的所有记录即可；</p>
<p>B+树辅助索引，比较：由于连续的记录可能存储于不同的磁盘块中，因此每取一条记录可能就需要一次IO操作；</p>
<p>复杂选择的实现：(合取(交)、析取(并)、取反)</p>
<p>利用一个索引的合取选择：首先判断是否存在某个简单条件中的某个属性上的一个存取路径，若存在就使用上面选择运算中除第一个之外的方式检索满足该条件的记录，然后在内存缓冲区中，通过测试每条检索到的记录是否满足其余的简单条件来最终完成操作。</p>
<p>使用组合索引的合取选择：如果选择指定的是两个或多个属性上的等值条件，并且在这些属性字段的组合上又存在组合索引，则可以直接搜索索引；</p>
<p>通过标识符的交实现合取选择：该算法要求各个条件所涉及的字段上有带记录指针的索引；此算法对每个索引进行扫描，获取那些指向满足单个条件的记录的指针，所有检索到的指针的交集就是那些满足合取条件的指针的集合。</p>
<p>通过标识符的交实现析取选择：该算法要求各个条件所涉及的字段上有带记录指针的索引；此算法对每个索引进行扫描，获取那些指向满足单个条件的记录的指针，所有检索到的指针的交集就是那些满足析取条件的指针的集合。</p>
<p>排序：</p>
<p>数据排序在RDBMS中有重要的作用：一是SQL查询会指明对结果进行排序，另一个当输入的关系已排序时，关系运算中的一些运算(如连接运算)能够得到高效实现。</p>
<p>对不能全部放在内存中的关系的排序称为外排序。外排序中最常用的技术是外部归并排序算法。</p>
<p>连接运算：</p>
<p>嵌套循环连接：代价很大；</p>
<p>块嵌套循环连接：缓冲区太小不能完全容纳任何一个关系时，使用此算法；</p>
<p>索引嵌套循环连接：内层关系上有索引时可使用此算法；</p>
<p>归并连接：排序-归并-连接</p>
<p>散列连接：可用于实现自然连接和等值连接；</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/mysql/mysql/" data-id="ck0m2ip3i000tq4u19cbwsvqz" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/mysql/4" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/mysql/4/" class="article-date">
  <time datetime="2019-09-16T07:05:47.900Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>MySQL优化框架</p>
<p> <img src="https://github.com/wulimax/blogs/blob/master/docs/img/5.png" alt></p>
<ol>
<li>SQL语句优化</li>
<li>索引优化</li>
<li>数据库结构优化</li>
<li>InnoDB表优化</li>
<li>MyISAM表优化</li>
<li>Memory表优化</li>
<li>理解查询执行计划</li>
<li>缓冲和缓存</li>
<li>锁优化</li>
<li>MySQL服务器优化</li>
<li>性能评估</li>
<li>MySQL优化内幕</li>
</ol>
<p>MySQL优化需要在三个不同层次上协调进行：MySQL级别、OS级别和硬件级别。MySQL级别的优化包括表优化、查询优化和MySQL服务器配置优化等，而MySQL的各种数据结构又最终作用于OS直至硬件设备，因此还需要了解每种结构对OS级别的资源的需要并最终导致的CPU和I/O操作等，并在此基础上将CPU及I/O操作需要尽量降低以提升其效率。</p>
<p>数据库层面的优化着眼点：<br>1、是否正确设定了表结构的相关属性，尤其是每个字段的字段类型是否为最佳。同时，是否为特定类型的工作组织使用了合适的表及表字段也将影响系统性能，比如，数据频繁更新的场景应该使用较多的表而每张表有着较少字段的结构，而复杂数据查询或分析的场景应该使用较少的表而每张表较多字段的结构等。<br>2、是否为高效进行查询创建了合适的索引。<br>3、是否为每张表选用了合适的存储引擎，并有效利用了选用的存储引擎本身的优势和特性。<br>4、是否基于存储引擎为表选用了合适的行格式(row format)。例如，压缩表在读写操作中会降低I/O操作需求并占用较少的磁盘空间，InnoDB支持读写应用场景中使用压缩表，但MyISAM仅能在读环境中使用压缩表。<br>5、是否使用了合适的锁策略，如在并发操作场景中使用共享锁，而对较高优先级的需求使用独占锁等。同时，还应该考虑存储引擎所支持的锁类型。<br>6、是否为InnoDB的缓冲池、MyISAM的键缓存以及MySQL查询缓存设定了合适大小的内存空间，以便能够存储频繁访问的数据且又不会引起页面换出。</p>
<p>操作系统和硬件级别的优化着眼点：<br>1、是否为实际的工作负载选定了合适的CPU，如对于CPU密集型的应用场景要使用更快速度的CPU甚至更多数量的CPU，为有着更多查询的场景使用更多的CPU等。基于多核以及超线程(hyperthreading)技术，现代的CPU架构越来越复杂、性能也越来越强了，但MySQL对多CPU架构的并行计算能力的利用仍然是有着不太尽如人意之处，尤其是较老的版本如MySQL 5.1之前的版本甚至无法发挥多CPU的优势。不过，通常需要实现的CPU性能提升目标有两类：低迟延和高吞吐量。低延迟需要更快速度的CPU，因为单个查询只能使用一颗；而需要同时运行许多查询的场景，多CPU更能提供更好的吞吐能力，然而其能否奏效还依赖于实际工作场景，因为MySQL尚不能高效的运行于多CPU，并且其对CPU数量的支持也有着限制。一般来说，较新的版本可以支持16至24颗CPU甚至更多。<br>2、是否有着合适大小的物理内存，并通过合理的配置平衡内存和磁盘资源，降低甚至避免磁盘I/O。现代的程序设计为提高性能通常都会基于局部性原理使用到缓存技术，这对于频繁操作数据的数据库系统来说尤其如此——有着良好设计的数据库缓存通常比针对通用任务的操作系统的缓存效率更高。缓存可以有效地延迟写入、优化写入，但并能消除写入，并综合考虑存储空间的可扩展性等，为业务选择合理的外部存储设备也是非常重要的工作。<br>3、是否选择了合适的网络设备并正确地配置了网络对整体系统系统也有着重大影响。延迟和带宽是网络连接的限制性因素，而常见的网络问题如丢包等，即是很小的丢包率也会赞成性能的显著下降。而更重要的还有按需调整系统中关网络方面的设置，以高效处理大量的连接和小查询。<br>4、是否基于操作系统选择了适用的文件系统。实际测试表明大部分文件系统的性能都非常接近，因此，为了性能而苦选文件系统并不划算。但考虑到文件系统的修复能力，应该使用日志文件系统如ext3、ext4、XFS等。同时，关闭文件系统的某些特性如访问时间和预读行为，并选择合理的磁盘调度器通常都会给性能提升带来帮助。<br>5、MySQL为响应每个用户连接使用一个单独的线程，再加内部使用的线程、特殊目的线程以及其它任何由存储引擎创建的线程等，MySQL需要对这些大量线程进行有效管理。Linux系统上的NPTL线程库更为轻量级也更有效率。MySQL 5.5引入了线程池插件，但其效用尚不明朗。</p>
<p>使用InnoDB存储引擎最佳实践：<br>1、基于MySQL查询语句中最常用的字段或字段组合创建主键，如果没有合适的主键也最好使用AUTO_INCRMENT类型的某字段为主键。<br>2、根据需要考虑使用多表查询，将这些表通过外键建立约束关系。<br>3、关闭autocommit。<br>4、使用事务(START TRANSACTION和COMMIT语句)组合相关的修改操作或一个整体的工作单元，当然也不应该创建过大的执行单元。<br>5、停止使用LOCK TABLES语句，InnoDB可以高效地处理来自多个会话的并发读写请求。如果需要在一系列的行上获取独占访问权限，可以使用SELECT … FOR UPDATE锁定仅需要更新的行。<br>6、启用innodb_file_per_table选项，将各表的数据和索引分别进行存放。<br>7、评估数据和访问模式是否能从InnoDB的表压缩功能中受益(在创建表时使用ROW_FORMAT=COMPRESSED选项)，如果可以，则应该启用压缩功能。</p>
<p>EXPLAIN语句解析：<br>id:SELECT语句的标识符，一般为数字，表示对应的SELECT语句在原始语句中的位置。没有子查询或联合的整个查询只有一个SELECT语句，因此其id通常为1。在联合或子查询语句中，内层的SELECT语句通常按它们在原始语句中的次序进行编号。但UNION操作通常最后会有一个id为NULL的行，因为UNION的结果通常保存至临时表中，而MySQL需要到此临时表中取得结果。</p>
<p>select_type:<br>即SELECT类型，有如下值列表：<br>SIMPLE：简单查询，即没有使用联合或子查询；<br>PRIMARY：UNION的最外围的查询或者最先进行的查询；<br>UNION：相对于PRIMARY，为联合查询的第二个及以后的查询；<br>DEPENDENT UNION：与UNION相同，但其位于联合子查询中(即UNION查询本身是子查询)；<br>UNION RESULT：UNION的执行结果；<br>SUBQUERY：非从属子查询，优化器通常认为其只需要运行一次；<br>DEPENDENT SUBQUERY：从属子查询，优化器认为需要为外围的查询的每一行运行一次，如用于IN操作符中的子查询；<br>DERIVED：用于FROM子句的子查询，即派生表查询；</p>
<p>table:<br>输出信息所关系到的表的表名，也有可能会显示为如下格式：<br>&lt;unionM,N&gt;：id为M和N的查询执行联合查询后的结果；<br><derivedn>：id为N的查询执行的结果集；</derivedn></p>
<p>type:<br>MySQL官方手册中解释type的作用为“type of join(联结的类型)”，但其更确切的意思应该是“记录(record)访问类型”，因为其主要目的在于展示MySQL在表中找到所需行的方式。通常有如下所示的记录访问类型：<br>system: 表中仅有一行，是const类型的一种特殊情况；<br>const：表中至多有一个匹配的行，该行仅在查询开始时读取一次，因此，该行此字段中的值可以被优化器看作是个常量(constant)；当基于PRIMARY KEY或UNIQUE NOT NULL字段查询，且与某常量进行等值比较时其类型就为const，其执行速度非常快；<br>eq_ref：类似于const，表中至多有一个匹配的行，但比较的数值不是某常量，而是来自于其它表；ed_ref出现在PRIMARY KEY或UNIQUE NOT NULL类型的索引完全用于联结操作中进行等值(=)比较时；这是除了system和const之外最好的访问类型；<br>ref：查询时的索引类型不是PRIMARY KEY或UNIQUE NOT NULL导致匹配到的行可能不惟一，或者仅能用到索引的左前缀而非全部时的访问类型；ref可被用于基于索引的字段进行=或&lt;=&gt;操作；<br>fulltext：用于FULLTEXT索引中用纯文本匹配的方法来检索记录。<br>ref_or_null：类似于ref，但可以额外搜索NULL值；<br>index_merge：使用“索引合并优化”的记录访问类型，相应地，其key字段(EXPLAIN的输出结果)中会出现用到的多个索引，key_len字段中会出现被使用索引的最长长度列表；将多个“范围扫描(range scan)”获取到的行进行合并成一个结果集的操作即索引合并(index merge)。<br>unique_subquery：用于IN比较操作符中的子查询中进行的“键值惟一”的访问类型场景中，如 value IN (SELECT primary_key FROM single_table WHERE some_expr)；<br>index_subquery：类似于unique_subquery，但子查询中键值不惟一；<br>range：带有范围限制的索引扫描，而非全索引扫描，它开始于索引里的某一点，返回匹配那个值的范围的行；相应地，其key字段(EXPLAIN的输出结果)中会输出所用到的索引，key_len字段中会包含用到的索引的最长部分的长度；range通常用于将索引与常量进行=、&lt;&gt;、&gt;、&gt;=、&lt;、&lt;=、IS NULL、&lt;=&gt;、BETWEEN或IN()类的比较操作中；<br>index：同全表扫描(ALL)，只不过是按照索引的次序进行而不行的次序；其优点是避免了排序，但是要承担按索引次序读取整个表的开销，这意味着若是按随机次序访问行，代价将非常大；<br>ALL：“全表扫描”的方式查找所需要的行，如果第一张表的查询类型(EXPLAIN的输出结果)为const，其性能可能不算太坏，而第一张表的查询类型为其它结果时，其性能通常会非常差；</p>
<p>Extra:<br>Using where：MySQL服务器将在存储引擎收到数据后进行“后过滤(post-filter)”以限定发送给下张表或客户端的行；如果WHERE条件中使用了索引列，其读取索引时就由存储引擎检查，因此，并非所有带有WHERE子句的查询都会显示“Using where”；<br>Using index：表示所需要的数据从索引就能够全部获取到，从而不再需要从表中查询获取所需要数据，这意味着MySQL将使用覆盖索引；但如果同时还出现了Using where，则表示索引将被用于查找特定的键值；<br>Using index for group-by：类似于Using index，它表示MySQL可仅通过索引中的数据完成GROUP BY或DISTINCT类的查询；<br>Using filesort：表示MySQL会对结果使用一个外部索引排序，而不是从表里按索引次序来读取行；</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/mysql/4/" data-id="ck0m2ip3g000sq4u1hw0pr2us" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/mysql/2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/mysql/2/" class="article-date">
  <time datetime="2019-09-16T07:05:47.894Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Explain是什么 </p>
<p>1    SIMPLE    dlc_device    index    index_siteid    index_siteid    4        7391    Using where</p>
<p>使用Explain关键字可以模拟优化器执行SQL查询语句,从而知道MySQL是如何处理你的SQL语句的。分徐你的查询语句或是表结构的性能瓶颈</p>
<p>Explain能干嘛 </p>
<p>表的读取顺序 </p>
<p>数据读取操作的操作类型 </p>
<p>哪些索引可以使用 </p>
<p>哪些索引可以被实际使用 </p>
<p>表之间的引用 </p>
<p>每张表有多少航被优化器查询 </p>
<p>Explain如何使用 </p>
<p>Explain + SQL语句</p>
<p>执行计划包含的信息 </p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>Extra</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>SIMPLE</td>
<td>dlc_device</td>
<td>index</td>
<td>index_siteid</td>
<td>index_siteid</td>
<td>4</td>
<td></td>
<td>7391</td>
<td>Using where</td>
</tr>
</tbody></table>
<p>id </p>
<p>select查询的序列号,表示查询中执行select子句或操作表的顺序<br>id相同,执行顺序由上至下<br>id不同,如果是子查询,id的序号会递增,id值越大优先级越高,越先被执行</p>
<p>select_type </p>
<p>主要有以下6种</p>
<p>SIMPLE </p>
<p>简单的SELECT查询,查询中不包含子查询或者UNION </p>
<p>PRIMARY </p>
<p>查询中若包含任何复杂的子部分,最外层查询则被标记为PRIMARY </p>
<p>SUBQUERY </p>
<p>在SELECT或WHERE列表中包含了子查询 </p>
<p>DERIVED </p>
<p>在FROM列表中包含的子查询被标记为DERIVED(衍生),MySQL会地柜执行这些子查询,把结果放在临时表里 </p>
<p>UNION </p>
<p>若第二个SELECT出现在UNION之后,则被标记为UNION;若UNION包含在FROM子句的子查询中,外层SELECT将被标记为DERIVED </p>
<p>UNION RESULT </p>
<p>从UNION表获取结果的SELECT </p>
<p>table </p>
<p>显示一行的数据是关于哪张表的</p>
<p>type </p>
<p>主要有以下8种</p>
<p>ALL </p>
<p>Full Table Scan,将遍历全表以找到匹配行 </p>
<p>index </p>
<p>Full Index Scan,index与ALL的区别为index类型之便利索引树,这通常要ALL快,因为索引文件通常比数据文件小 </p>
<p>range </p>
<p>只检索给定范围的行,使用一个索引来选择行。key列显示使用了哪个索引。一般就是在你的where语句中出现了between,&lt;,&gt;,in等的查询,这种扫描索引比扫描权标要好,因为只需要开始于索引的某一点,二结束于另一点,不用扫描全部索引。 </p>
<p>ref </p>
<p>非唯一性索引扫描,返回匹配某个单独值的所有行。本质上也是一种索引访问,它返回所有匹配某个单独值的行,然而它可能会找到多个符合条件的行,所以他应该属于查找和扫描的混合体 </p>
<p>eq_ref </p>
<p>唯一性索引扫描,对于每个索引健,表中只有一条记录与之匹配。常见主键或唯一主键扫描 </p>
<p>const </p>
<p>表示通过索引一次就找到了,const用于比较primary key或者unique索引。因为只匹配一行数据,所以很快 </p>
<p>system </p>
<p>表只有一行记录(等于系统表),这是const类型的特例,平时不会出现,这个也可以忽略不计 </p>
<p>NULL </p>
<p>显示查询了何种类型 </p>
<p>从最好到最差依次是:system&gt;const&gt;eq_ref&gt;ref&gt;range&gt;index&gt;ALL </p>
<p>一般来说,得保证查询至少达到range级别,最好能达到ref </p>
<p>possible_keys </p>
<p>显示可能引用在这张表中的索引,一个或多个,查询涉及到字段上若存在索引,则该索引将被列出,但不一定查询实际使用</p>
<p>key </p>
<p>实际使用的索引,如果为NULL,则没有使用索引<br>查询中若使用了覆盖索引(查询的字段和索引字段符合),则该索引仅出现在key列表中</p>
<p>key_len </p>
<p>表示索引中使用的字节数,可通过高该列计算查询中使用的索引长度。在不损失精确性的情况下,长度越短越好。key_len显示的值为索引字段的最大可能长度,并非实际使用长度,即key_len是根据表定义计算而得,不是通过表内检索出的</p>
<p>ref </p>
<p>表示索引的哪一列被使用了,如果可能的话,是一个常数,哪些列或常量被用于查找索引列上的值</p>
<p>rows </p>
<p>根据表的统计信息及索引选用情况,大致估算出找到所需的记录所需要读取的行数</p>
<p>Extra </p>
<p>包含不适合在其他列中显示但十分重要的额外信息,其中前三个比较常见</p>
<p>Using filesort </p>
<p>说明MySQL会对数据使用一个外部的索引排序,而不是按照表内的索引顺序进行读取。MySQL中无法利用索引完成的排序操作称为“文件排序” </p>
<p>Using temporary </p>
<p>使用了临时表保存中间结果,MySQL在对查询结果排序时使用临时表。常见于order by和分组查询group by </p>
<p>Using index </p>
<p>表示相应的select操作中使用了覆盖索引,避免访问了表的数据航,效率不错! </p>
<p>如果同时出现Using where,表明索引 </p>
<p>Using where </p>
<p>表示使用了where过滤 </p>
<p>Using join buffer </p>
<p>表示使用了连接缓存 </p>
<p>impossible where </p>
<p>where子句的值总是false,不能用来获取任何元祖 </p>
<p>select tables optimized away </p>
<p>在没有group by子句的情况下,基于索引优化min/max操作或者对于MyISAM存储引擎优化COUNT(*)操作,不必等到执行阶段再进行计算,查询执行计划生成的阶段即完成优化 </p>
<p>distinct </p>
<p>优化distinct操作,在找到第一匹配的元祖后即停止找同样的动作 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/mysql/2/" data-id="ck0m2ip3d000pq4u1ikgq5kl6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/maxwell/README" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/maxwell/README/" class="article-date">
  <time datetime="2019-09-16T07:05:47.879Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li><p>方案一</p>
<p>mysql 通过binlog  同步给 maxwell  </p>
<p>-&gt; maxwell解析binlog日志 同步给kafka </p>
<p>-&gt; 使用php swoole的定时功能 通过定时器 获取kafka的数据</p>
<p>-&gt; 获取出来的数据 导入到elasticsearch</p>
<p>-&gt; 创建索引 创建文档 对数据进行操作</p>
<hr>
</li>
</ol>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./es/vendor/autoload.php'</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Elasticsearch</span>\<span class="title">ClientBuilder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">moaili</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $broker_list = <span class="string">'spark1:9092,spark2:9092,spark4:9092'</span>;<span class="comment">//配置kafka，可以用逗号隔开多个kafka</span></span><br><span class="line">    <span class="keyword">public</span> $topic = <span class="string">'test'</span>;</span><br><span class="line">    <span class="keyword">public</span> $partition = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">protected</span> $producer = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> $consumer = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">protected</span> $kafkaObj = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> $client = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;esinit();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**kafka消费端**/</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tokpic</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;    </span><br><span class="line">        <span class="comment">/************连接kafka******************/</span></span><br><span class="line">        $conf = <span class="keyword">new</span> \RdKafka\Conf();</span><br><span class="line">        $conf-&gt;set(<span class="string">'group.id'</span>, <span class="number">0</span>);</span><br><span class="line">        $conf-&gt;set(<span class="string">'metadata.broker.list'</span>, <span class="keyword">$this</span>-&gt;broker_list);</span><br><span class="line">        $topicConf = <span class="keyword">new</span> \RdKafka\TopicConf();</span><br><span class="line">        $topicConf-&gt;set(<span class="string">'auto.offset.reset'</span>, <span class="string">'smallest'</span>);</span><br><span class="line">        $conf-&gt;setDefaultTopicConf($topicConf);</span><br><span class="line">        $consumer = <span class="keyword">new</span> \RdKafka\KafkaConsumer($conf);</span><br><span class="line">        $consumer-&gt;subscribe([<span class="keyword">$this</span>-&gt;topic]); </span><br><span class="line">        <span class="comment">/*************************************/</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;kafkaObj = $consumer;</span><br><span class="line">        </span><br><span class="line">          <span class="comment">//每隔2000ms触发一次</span></span><br><span class="line">        swoole_timer_tick(<span class="number">2000</span>, <span class="function"><span class="keyword">function</span> <span class="params">($timer_id)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">echo</span> date(<span class="string">'Y-m-d H:i:s'</span>,time());</span><br><span class="line">           <span class="keyword">echo</span> <span class="string">'运行后内存：'</span>.round(memory_get_usage()/<span class="number">1024</span>/<span class="number">1024</span>, <span class="number">2</span>) .<span class="string">' MB'</span>.PHP_EOL ;</span><br><span class="line">          </span><br><span class="line">            $message = <span class="keyword">$this</span>-&gt;kafkaObj-&gt;consume(<span class="number">120</span>*<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">switch</span> ($message-&gt;err) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> RD_KAFKA_RESP_ERR_NO_ERROR:</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;czes($message);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RD_KAFKA_RESP_ERR__TIMED_OUT:</span><br><span class="line">                    var_dump(<span class="string">'异常'</span>);</span><br><span class="line">                     swoole_timer_clear($timer_id);</span><br><span class="line">                    <span class="keyword">break</span>; </span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//=====</span></span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">/*获取数据操作es </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">czes</span><span class="params">(&amp;$data)</span></span>&#123;</span><br><span class="line">    var_dump($data);</span><br><span class="line">   </span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**创建mysql链接**/</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">msyqlpdo</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="comment">//1.建立连接</span></span><br><span class="line">        $connect=mysqli_connect(<span class="string">'spark1'</span>,<span class="string">'root'</span>,<span class="string">'123456'</span>,<span class="string">'company'</span>,<span class="string">'3306'</span>);</span><br><span class="line">        mysqli_query($connect,<span class="string">'set names utf8'</span>);</span><br><span class="line">        var_dump($connect);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**创建es链接**/</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">esinit</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;client == <span class="keyword">null</span>)&#123;</span><br><span class="line">      $params = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'spark2:9200'</span>,</span><br><span class="line">            <span class="string">'spark3:9092'</span>,</span><br><span class="line">            <span class="string">'spark4:9092'</span></span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">$this</span>-&gt;client = ClientBuilder::create()-&gt;setHosts($params)-&gt;build();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 创建索引</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create_index</span><span class="params">($index_name = <span class="string">''</span>)</span> </span>&#123; <span class="comment">// 只能创建一次</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">empty</span>($index_name))&#123; <span class="keyword">return</span> <span class="keyword">false</span>;&#125;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;esinit();</span><br><span class="line">        $params = [</span><br><span class="line">            <span class="string">'index'</span> =&gt; $index_name,</span><br><span class="line">            <span class="string">'body'</span> =&gt; [</span><br><span class="line">                <span class="string">'settings'</span> =&gt; [</span><br><span class="line">                    <span class="string">'number_of_shards'</span> =&gt; <span class="number">1</span>, <span class="comment">//是数据备份数，如果只有一台机器，设置为0</span></span><br><span class="line">                    <span class="string">'number_of_replicas'</span> =&gt; <span class="number">1</span> <span class="comment">//是数据分片数，默认为5，有时候设置为3</span></span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;client-&gt;indices()-&gt;create($params);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Elasticsearch\Common\Exceptions\BadRequest400Exception $e) &#123;</span><br><span class="line">            $msg = $e-&gt;getMessage();</span><br><span class="line">            $msg = json_decode($msg,<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> $msg;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除索引</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete_index</span><span class="params">($index_name = <span class="string">'test_ik'</span>)</span> </span>&#123;</span><br><span class="line">        $params = [<span class="string">'index'</span> =&gt; $index_name];</span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;client-&gt;indices()-&gt;delete($params);</span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建文档模板</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create_mappings</span><span class="params">($index_name = <span class="string">''</span>,$type_name = <span class="string">'goods'</span>)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">empty</span>($index_name))&#123; <span class="keyword">return</span> <span class="keyword">false</span>; &#125;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;esinit();</span><br><span class="line">        $params = [</span><br><span class="line">            <span class="string">'index'</span> =&gt; $index_name,</span><br><span class="line">            <span class="string">'type'</span> =&gt; $type_name,</span><br><span class="line">            <span class="string">'body'</span> =&gt; [</span><br><span class="line">                $type_name =&gt; [</span><br><span class="line">                    <span class="string">'_source'</span> =&gt; [</span><br><span class="line">                        <span class="string">'enabled'</span> =&gt; <span class="keyword">true</span></span><br><span class="line">                    ],</span><br><span class="line">                    <span class="string">'properties'</span> =&gt; [</span><br><span class="line">                        <span class="string">'id'</span> =&gt; [</span><br><span class="line">                            <span class="string">'type'</span> =&gt; <span class="string">'integer'</span>, <span class="comment">// 整型</span></span><br><span class="line">                        ],</span><br><span class="line">                        <span class="string">'name'</span> =&gt; [</span><br><span class="line">                            <span class="string">'type'</span> =&gt; <span class="string">'text'</span>, <span class="comment">// 字符串型</span></span><br><span class="line">                        ],</span><br><span class="line">                        <span class="string">'age'</span> =&gt; [</span><br><span class="line">                            <span class="string">'type'</span> =&gt; <span class="string">'integer'</span>,</span><br><span class="line">                        ]</span><br><span class="line">                    ]</span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;client-&gt;indices()-&gt;putMapping($params);</span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查看映射</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_mapping</span><span class="params">($index_name = <span class="string">''</span>,$type_name = <span class="string">'goods'</span>)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">empty</span>($index_name))&#123; <span class="keyword">return</span> <span class="keyword">false</span>; &#125;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;esinit();</span><br><span class="line">        $params = [</span><br><span class="line">            <span class="string">'index'</span> =&gt; $index_name,</span><br><span class="line">            <span class="string">'type'</span> =&gt; $type_name</span><br><span class="line">        ];</span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;client-&gt;indices()-&gt;getMapping($params);</span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加文档</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_doc</span><span class="params">($index_name = <span class="string">''</span>,$doc,$id,$type_name = <span class="string">'goods'</span>)</span> </span>&#123;</span><br><span class="line">      </span><br><span class="line">        $params = [</span><br><span class="line">            <span class="string">'index'</span> =&gt; $index_name,</span><br><span class="line">            <span class="string">'type'</span> =&gt; $type_name,</span><br><span class="line">            <span class="string">'body'</span> =&gt; $doc</span><br><span class="line">        ];</span><br><span class="line">         <span class="keyword">if</span>($id != <span class="string">''</span>|| <span class="keyword">isset</span>($doc[<span class="string">'id'</span>]))&#123; $params[<span class="string">'id'</span>] = $id !=<span class="string">''</span>?$id:$doc[<span class="string">'id'</span>];&#125;</span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;client-&gt;index($params);</span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断文档存在</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exists_doc</span><span class="params">($index_name = <span class="string">''</span>,$id = <span class="string">''</span>,$type_name = <span class="string">'goods'</span>)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">empty</span>($index_name))&#123; <span class="keyword">return</span> <span class="keyword">false</span>; &#125;</span><br><span class="line">        $params = [</span><br><span class="line">            <span class="string">'index'</span> =&gt; $index_name,</span><br><span class="line">            <span class="string">'type'</span> =&gt; $type_name</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">if</span>($id != <span class="string">''</span>)&#123; $params[<span class="string">'id'</span>] = $id;&#125;</span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;client-&gt;exists($params);</span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取文档</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_doc</span><span class="params">($index_name = <span class="string">''</span>,$id = <span class="string">''</span>,$type_name = <span class="string">'goods'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($index_name))&#123; <span class="keyword">return</span> <span class="keyword">false</span>; &#125;</span><br><span class="line">        $params = [</span><br><span class="line">            <span class="string">'index'</span> =&gt; $index_name,</span><br><span class="line">            <span class="string">'type'</span> =&gt; $type_name,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">if</span>($id != <span class="string">''</span>)&#123; $params[<span class="string">'id'</span>] = $id;&#125;</span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;client-&gt;get($params);</span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新文档</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_doc</span><span class="params">($index_name = <span class="string">''</span>,$data= <span class="string">''</span>,$id = <span class="string">''</span>,$type_name = <span class="string">'goods'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($index_name) || <span class="keyword">empty</span>($data))&#123; <span class="keyword">return</span> <span class="keyword">false</span>; &#125;</span><br><span class="line">        <span class="comment">// 可以灵活添加新字段,最好不要乱添加</span></span><br><span class="line">        $params = [</span><br><span class="line">            <span class="string">'index'</span> =&gt; $index_name,</span><br><span class="line">            <span class="string">'type'</span> =&gt; $type_name,</span><br><span class="line">            <span class="string">'body'</span> =&gt; [</span><br><span class="line">                <span class="string">'doc'</span>=&gt; $data <span class="comment">//这里的data是个一维关联数组，和常用的ORM更新方法参数一致。</span></span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">if</span>($id != <span class="string">''</span>|| <span class="keyword">isset</span>($data[<span class="string">'id'</span>]))&#123; $params[<span class="string">'id'</span>] = ($id ==<span class="string">''</span>?$data[<span class="string">'id'</span>]:$id);&#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;client-&gt;update($params);</span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Elasticsearch\Common\Exceptions\BadRequest400Exception $e) &#123;</span><br><span class="line">            $msg = $e-&gt;getMessage();</span><br><span class="line">            $msg = json_decode($msg,<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> $msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除文档</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete_doc</span><span class="params">($index_name = <span class="string">''</span>,$id = <span class="string">''</span>,$type_name = <span class="string">'goods'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($index_name) || <span class="keyword">empty</span>($id))&#123; <span class="keyword">return</span> <span class="keyword">false</span>; &#125;</span><br><span class="line">       $params = [</span><br><span class="line">            <span class="string">'index'</span> =&gt; $index_name,</span><br><span class="line">            <span class="string">'type'</span> =&gt; $type_name,</span><br><span class="line">            <span class="string">'id'</span> =&gt; $id</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;client-&gt;delete($params);</span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询文档 (分页，排序，权重，过滤)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">search_doc</span><span class="params">($index_name = <span class="string">""</span>,$keywords = <span class="string">""</span>,$type_name = <span class="string">"goods"</span>,$from = <span class="number">0</span>,$size = <span class="number">2</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($index_name))&#123; <span class="keyword">return</span> <span class="keyword">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">       $params = [</span><br><span class="line">            <span class="string">'index'</span> =&gt; $index_name,</span><br><span class="line">            <span class="string">'type'</span> =&gt; $type_name,</span><br><span class="line">            <span class="string">'body'</span> =&gt; [</span><br><span class="line">                <span class="string">'query'</span> =&gt; [</span><br><span class="line">                    <span class="string">'bool'</span> =&gt; [</span><br><span class="line">                        <span class="string">'should'</span> =&gt; [</span><br><span class="line">                            [ <span class="string">'match'</span> =&gt; [ <span class="string">'name'</span> =&gt; [</span><br><span class="line">                                <span class="string">'query'</span> =&gt; $keywords,</span><br><span class="line">                                <span class="string">'boost'</span> =&gt; <span class="number">3</span>, <span class="comment">// 权重大</span></span><br><span class="line">                            ]]],</span><br><span class="line"><span class="comment">//                            [ 'match' =&gt; [ 'content' =&gt; [</span></span><br><span class="line"><span class="comment">//                                'query' =&gt; $keywords,</span></span><br><span class="line"><span class="comment">//                                'boost' =&gt; 2,</span></span><br><span class="line"><span class="comment">//                            ]]],</span></span><br><span class="line">                        ],</span><br><span class="line">                    ],</span><br><span class="line">                ],</span><br><span class="line"><span class="comment">//                'sort' =&gt; ['price'=&gt;['order'=&gt;'desc']],</span></span><br><span class="line">                 <span class="string">'from'</span> =&gt; $from, <span class="string">'size'</span> =&gt; $size</span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $results = <span class="keyword">$this</span>-&gt;client-&gt;search($params);</span><br><span class="line"><span class="comment">//        $maxScore  = $results['hits']['max_score'];</span></span><br><span class="line"><span class="comment">//        $score = $results['hits']['hits'][0]['_score'];</span></span><br><span class="line"><span class="comment">//        $doc   = $results['hits']['hits'][0]['_source'];</span></span><br><span class="line">        <span class="keyword">return</span> $results;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> moaili();</span><br><span class="line"><span class="comment">// $a-&gt;tokpic();</span></span><br><span class="line"><span class="comment">// 创建索引</span></span><br><span class="line"><span class="comment">//$res = $a-&gt;create_index('test');</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建文档模板</span></span><br><span class="line"><span class="comment">// $res = $a-&gt;create_mappings('test');</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//添加文档</span></span><br><span class="line">$data = <span class="keyword">array</span>(<span class="string">'name'</span>=&gt;<span class="string">'李四五'</span>);</span><br><span class="line"><span class="comment">//$res = $a-&gt;add_doc('test',$data);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//查看映射</span></span><br><span class="line"><span class="comment">//$res = $a-&gt;get_mapping('test');</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//查看文档是否存在</span></span><br><span class="line"><span class="comment">//$res = $a-&gt;exists_doc('test','9KRExWoBrmEreIfCCd2g');</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//更新文档</span></span><br><span class="line"><span class="comment">//$res = $a-&gt;update_doc('test',$data,1);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//删除文档</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//搜索文档</span></span><br><span class="line"><span class="comment">//$res = $a-&gt;search_doc('test','李');</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//链接数据库</span></span><br><span class="line">$a-&gt;msyqlpdo();</span><br><span class="line"></span><br><span class="line"><span class="comment">// var_dump($res);</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/maxwell/README/" data-id="ck0m2ip3f000qq4u1ak3sxv1o" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docs/maxwell/ESapi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/16/docs/maxwell/ESapi/" class="article-date">
  <time datetime="2019-09-16T07:05:47.866Z" itemprop="datePublished">2019-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>目的 搜索引擎从sphinx 切换到 es 为了不使业务变动太多 所有封装 继承 <a href="https://github.com/wulimax/fs2/blob/master/sphinx/README.md" target="_blank" rel="noopener">sphinx 部分接口</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**elasticesarch 封装类</span></span><br><span class="line"><span class="comment">  * Class elasticsearch</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">elasticsearch</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span>  $esobj;</span><br><span class="line">    <span class="keyword">private</span> $host = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($host =null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">self</span>::$esobj))&#123;<span class="keyword">self</span>::$esobj = @curl_init();&#125; <span class="comment">//静态化链接方式</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;host = ($host ==<span class="keyword">null</span>)?<span class="keyword">$this</span>-&gt;host:$host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">post_url</span><span class="params">($url, $data = <span class="string">''</span>,$method = <span class="string">'GET'</span>,$others=[])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $header = <span class="keyword">isset</span>($others[<span class="string">'header'</span>]) ?$others[<span class="string">'$header'</span>]:[<span class="string">'Content-Type: application/json'</span>];</span><br><span class="line">        $referrer = <span class="keyword">isset</span>($others[<span class="string">'referrer'</span>])?$others[<span class="string">'referrer'</span>]:<span class="string">''</span>;</span><br><span class="line">        $useragent = <span class="keyword">isset</span>($others[<span class="string">'useragent'</span>])?$others[<span class="string">'useragent'</span>]:<span class="string">'Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1)'</span>;</span><br><span class="line">        $cookie = <span class="keyword">isset</span>($others[<span class="string">'cookie'</span>])?$others[<span class="string">'cookie'</span>]:<span class="string">''</span>;</span><br><span class="line">        $proxy = <span class="keyword">isset</span>($others[<span class="string">'proxy'</span>])?$others[<span class="string">'proxy'</span>]: <span class="number">-1</span>;</span><br><span class="line">        $sock = <span class="keyword">isset</span>($others[<span class="string">'sock'</span>])?$others[<span class="string">'sock'</span>]:<span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//curl 方式</span></span><br><span class="line">        <span class="keyword">if</span> (function_exists(<span class="string">'curl_init'</span>) &amp;&amp; <span class="keyword">empty</span>($cookie)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">self</span>::$esobj))&#123;<span class="keyword">self</span>::$esobj = @curl_init();&#125; <span class="comment">//静态化链接方式</span></span><br><span class="line">            $ch = <span class="keyword">self</span>::$esobj;</span><br><span class="line">            <span class="keyword">if</span>($method == <span class="string">'GET'</span> &amp;&amp; !<span class="keyword">empty</span>($data))&#123;</span><br><span class="line">                <span class="keyword">if</span>(is_string($data))&#123;</span><br><span class="line">                    $url = $url.<span class="string">'?'</span>.$data;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    $querystring = http_build_query($data);</span><br><span class="line">                    $url = $url.<span class="string">'?'</span>.$querystring;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            @curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">            <span class="keyword">if</span> ($proxy != <span class="number">-1</span> &amp;&amp; !<span class="keyword">empty</span>($proxy)) @curl_setopt($ch, CURLOPT_PROXY, <span class="string">'http://'</span> . $proxy);</span><br><span class="line">            @curl_setopt($ch, CURLOPT_REFERER, $referrer);<span class="comment">//在HTTP请求头中"Referer: "的内容。</span></span><br><span class="line">            @curl_setopt($ch, CURLOPT_USERAGENT, $useragent);<span class="comment">//在HTTP请求中包含一个"User-Agent: "头的字符串。</span></span><br><span class="line">            @curl_setopt($ch, CURLOPT_COOKIEJAR, COOKIE_FILE_PATH); <span class="comment">//链接后保存cookie信息</span></span><br><span class="line">            @curl_setopt($ch, CURLOPT_COOKIEFILE, COOKIE_FILE_PATH); <span class="comment">//cookie保存类型</span></span><br><span class="line">            @curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);  <span class="comment">//</span></span><br><span class="line">            @curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">            @curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>);<span class="comment">//启用时会将服务器服务器返回的"Location: "放在header中递归的返回给服务器，使用CURLOPT_MAXREDIRS可以限定递归返回的数量。</span></span><br><span class="line">            @curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, <span class="number">30</span>);<span class="comment">//	在尝试连接时等待的秒数。设置为0，则无限等待。</span></span><br><span class="line">            @curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">60</span>); <span class="comment">//允许 cURL 函数执行的最长秒数。</span></span><br><span class="line">            @curl_setopt($ch, CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4);<span class="comment">//允许程序选择想要解析的 IP 地址类别</span></span><br><span class="line">            @curl_setopt($ch, CURLOPT_HTTPHEADER, $header);	<span class="comment">//设置 HTTP 头字段的数组</span></span><br><span class="line">            <span class="keyword">if</span>($method == <span class="string">'POST'</span>)&#123;</span><br><span class="line">                curl_setopt($ch, CURLOPT_CUSTOMREQUEST,<span class="string">'POST'</span>);     <span class="comment">// 请求方式</span></span><br><span class="line">                curl_setopt($ch, CURLOPT_POST, <span class="keyword">true</span>);        <span class="comment">// post提交</span></span><br><span class="line">                curl_setopt($ch, CURLOPT_POSTFIELDS, $data);   <span class="comment">// post的变量</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>($method == <span class="string">'PUT'</span>)&#123;</span><br><span class="line">                curl_setopt ($ch, CURLOPT_CUSTOMREQUEST, <span class="string">"PUT"</span>);</span><br><span class="line">                curl_setopt($ch, CURLOPT_POSTFIELDS,$data);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>($method == <span class="string">'DELETE'</span>)&#123;</span><br><span class="line">                curl_setopt ($ch, CURLOPT_CUSTOMREQUEST, <span class="string">"DELETE"</span>);</span><br><span class="line">                curl_setopt($ch, CURLOPT_POSTFIELDS,$data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $result = @curl_exec($ch);</span><br><span class="line">            <span class="comment">// 释放资源  --暂时不释放资源</span></span><br><span class="line">            @curl_close($ch);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//file_get_contents 方式</span></span><br><span class="line">        <span class="keyword">if</span> ($result === <span class="keyword">false</span> &amp;&amp; function_exists(<span class="string">'file_get_contents'</span>)) &#123;</span><br><span class="line">            $urls = parse_url($url);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>($host)) $host = $urls[<span class="string">'host'</span>];</span><br><span class="line">            $httpheader = $method . <span class="string">" "</span> . $url . <span class="string">" HTTP/1.1\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Accept: */*\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Accept-Language: zh-cn\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Referer: "</span> . $referrer . <span class="string">"\r\n"</span>;</span><br><span class="line">            <span class="keyword">if</span> ($method == <span class="string">'POST'</span>) $httpheader .= <span class="string">"Content-Type: application/x-www-form-urlencoded\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"User-Agent: "</span> . $useragent . <span class="string">"\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Host: "</span> . $host . <span class="string">"\r\n"</span>;</span><br><span class="line">            <span class="keyword">if</span> ($method == <span class="string">'POST'</span>) $httpheader .= <span class="string">"Content-Length: "</span> . strlen($data) . <span class="string">"\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Connection: Keep-Alive\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Cookie: "</span> . $cookie . <span class="string">"\r\n"</span>;</span><br><span class="line"></span><br><span class="line">            $opts = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">'http'</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">                    <span class="string">'method'</span> =&gt; $method,</span><br><span class="line">                    <span class="string">'header'</span> =&gt; $httpheader,</span><br><span class="line">                    <span class="string">'timeout'</span> =&gt; <span class="number">60</span>,</span><br><span class="line">                    <span class="string">'content'</span> =&gt;  $data</span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> ($proxy != <span class="number">-1</span> &amp;&amp; !<span class="keyword">empty</span>($proxy)) &#123;</span><br><span class="line">                $opts[<span class="string">'http'</span>][<span class="string">'proxy'</span>] = <span class="string">'tcp://'</span> . $proxy;</span><br><span class="line">                $opts[<span class="string">'http'</span>][<span class="string">'request_fulluri'</span>] = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $context = @stream_context_create($opts);</span><br><span class="line">            $result = @file_get_contents($url, <span class="string">'r'</span>, $context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//打开文件方式</span></span><br><span class="line">        <span class="keyword">if</span> ($sock &amp;&amp; $result === <span class="keyword">false</span> &amp;&amp; function_exists(<span class="string">'fsockopen'</span>)) &#123;</span><br><span class="line">            $urls = parse_url($url);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>($header)) $header = $urls[<span class="string">'host'</span>];</span><br><span class="line">            $port = <span class="keyword">empty</span>($urls[<span class="string">'port'</span>]) ? <span class="number">80</span> : $urls[<span class="string">'port'</span>];</span><br><span class="line"></span><br><span class="line">            $httpheader = $method . <span class="string">" "</span> . $url . <span class="string">" HTTP/1.1\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Accept: */*\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Accept-Language: zh-cn\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Referer: "</span> . $referrer . <span class="string">"\r\n"</span>;</span><br><span class="line">            <span class="keyword">if</span> ($method == <span class="string">'POST'</span>) $httpheader .= <span class="string">"Content-Type: application/x-www-form-urlencoded\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"User-Agent: "</span> . $useragent . <span class="string">"\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Host: "</span> . $host . <span class="string">"\r\n"</span>;</span><br><span class="line">            <span class="keyword">if</span> ($method == <span class="string">'POST'</span>) $httpheader .= <span class="string">"Content-Length: "</span> . strlen($data) . <span class="string">"\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Connection: Keep-Alive\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"Cookie: "</span> . $cookie . <span class="string">"\r\n"</span>;</span><br><span class="line">            $httpheader .= <span class="string">"\r\n"</span>;</span><br><span class="line">            <span class="keyword">if</span> ($method == <span class="string">'POST'</span>) $httpheader .= $data;</span><br><span class="line">            $fd = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> ($proxy != <span class="number">-1</span> &amp;&amp; !<span class="keyword">empty</span>($proxy)) &#123;</span><br><span class="line">                $proxys = explode(<span class="string">':'</span>, $proxy);</span><br><span class="line">                $fd = @fsockopen($proxys[<span class="number">0</span>], $proxys[<span class="number">1</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $fd = @fsockopen($host, $port);</span><br><span class="line">            &#125;</span><br><span class="line">            @fwrite($fd, $httpheader);</span><br><span class="line">            @stream_set_timeout($fd, <span class="number">60</span>);</span><br><span class="line">            $result = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">while</span> (!@feof($fd)) &#123;</span><br><span class="line">                $result .= @fread($fd, <span class="number">8192</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            @fclose($fd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">analysis</span><span class="params">(&amp;$result)</span></span>&#123;</span><br><span class="line">        $result = json_decode($result,<span class="keyword">true</span>);</span><br><span class="line">        $resData = [];</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($result[<span class="string">'hits'</span>][<span class="string">'hits'</span>]))&#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($result[<span class="string">'hits'</span>][<span class="string">'hits'</span>] <span class="keyword">as</span> $key=&gt; $item)&#123;</span><br><span class="line">                $resData[<span class="string">'hits'</span>][$key] = $item[<span class="string">'_source'</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($result[<span class="string">'aggregations'</span>]) )&#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($result[<span class="string">'aggregations'</span>] <span class="keyword">as</span> $key=&gt;$item)&#123;</span><br><span class="line">                $resData[<span class="string">'aggs'</span>][$key] = $item[<span class="string">'buckets'</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">unset</span>($result);</span><br><span class="line">        <span class="keyword">return</span> $resData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**封装常规查询api</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     $where['group_key'] = String	--分组查询</span></span><br><span class="line"><span class="comment">     $where['group_key_order'] = String	--	分组查询排序方式 DESC ASC</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> $where</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">es_api</span><span class="params">(&amp;$where)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(is_string($where))&#123; <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;exsql($where); &#125;</span><br><span class="line">        $reqdata = [];</span><br><span class="line">        $reqdata[<span class="string">'size'</span>] = <span class="number">20</span>;<span class="comment">//默认取二十条数据</span></span><br><span class="line">        <span class="comment">//过滤查询 == start</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'key'</span>]))&#123; <span class="comment">//in</span></span><br><span class="line">            <span class="keyword">foreach</span> ($where[<span class="string">'key'</span>] <span class="keyword">as</span> $key=&gt;$item)&#123;</span><br><span class="line">                <span class="keyword">if</span>(is_array($item))&#123;$reqdata[<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must'</span>][<span class="string">'terms'</span>][$key] = $item;&#125;</span><br><span class="line">                <span class="keyword">if</span>(is_string($item))&#123;$reqdata[<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must'</span>][<span class="string">'term'</span>][$key] = $item;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'not_key'</span>]))&#123; <span class="comment">//not in</span></span><br><span class="line">            <span class="keyword">foreach</span> ($where[<span class="string">'not_key'</span>] <span class="keyword">as</span> $key=&gt;$item)&#123;</span><br><span class="line">                <span class="keyword">if</span>(is_array($item))&#123;$reqdata[<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must_not'</span>][<span class="string">'terms'</span>][$key] = $item;&#125;</span><br><span class="line">                <span class="keyword">if</span>(is_string($item))&#123;$reqdata[<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must_not'</span>][<span class="string">'term'</span>][$key] = $item;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'or_key'</span>]))&#123; <span class="comment">//or in</span></span><br><span class="line">            <span class="keyword">foreach</span> ($where[<span class="string">'or_key'</span>] <span class="keyword">as</span> $key=&gt;$item)&#123;</span><br><span class="line">                <span class="keyword">if</span>(is_array($item))&#123;$reqdata[<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'should'</span>][<span class="string">'terms'</span>][$key] = $item;&#125;</span><br><span class="line">                <span class="keyword">if</span>(is_string($item))&#123;$reqdata[<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'should'</span>][<span class="string">'term'</span>][$key] = $item;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//范围查询</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'or_min'</span>]) &amp;&amp; <span class="keyword">isset</span>($where[<span class="string">'or_key'</span>]) &amp;&amp; $where[<span class="string">'or_max'</span>])&#123;</span><br><span class="line">            $reqdata[<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must'</span>][<span class="string">'range'</span>][$where[<span class="string">'or_key'</span>]][<span class="string">'gt'</span>] = $where[<span class="string">'or_min'</span>];<span class="comment">//大于</span></span><br><span class="line">            $reqdata[<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must'</span>][<span class="string">'range'</span>][$where[<span class="string">'or_key'</span>]][<span class="string">'lt'</span>] = $where[<span class="string">'or_max'</span>];<span class="comment">//小于</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'not_or_min'</span>]) &amp;&amp; <span class="keyword">isset</span>($where[<span class="string">'not_or_key'</span>]) &amp;&amp; $where[<span class="string">'not_or_max'</span>])&#123; <span class="comment">//范围查询</span></span><br><span class="line">            $reqdata[<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must_not'</span>][<span class="string">'range'</span>][$where[<span class="string">'not_or_key'</span>]][<span class="string">'gt'</span>] = $where[<span class="string">'not_or_min'</span>];<span class="comment">//大于</span></span><br><span class="line">            $reqdata[<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must_not'</span>][<span class="string">'range'</span>][$where[<span class="string">'not_or_key'</span>]][<span class="string">'lt'</span>] = $where[<span class="string">'not_or_max'</span>];<span class="comment">//小于</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'range'</span>]))&#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($where[<span class="string">'range'</span>] <span class="keyword">as</span> $key=&gt;$item)&#123;</span><br><span class="line">                $reqdata[<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must'</span>][<span class="string">'range'</span>][$key][<span class="string">'gt'</span>] = $item;</span><br><span class="line">                $reqdata[<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must'</span>][<span class="string">'range'</span>][$key][<span class="string">'lt'</span>] = $item;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'sorting'</span>]))&#123;</span><br><span class="line">            <span class="keyword">if</span>(is_array($where[<span class="string">'sorting'</span>]))&#123;$reqdata[<span class="string">'sort'</span>][$where[<span class="number">0</span>]][<span class="string">'order'</span>] = $where[<span class="number">1</span>];&#125;</span><br><span class="line">            <span class="keyword">if</span>(is_string($where[<span class="string">'sorting'</span>]))&#123;</span><br><span class="line">                $where[<span class="string">'sorting'</span>] = explode(<span class="string">' '</span>,trim($where[<span class="string">'sorting'</span>]));</span><br><span class="line">                $reqdata[<span class="string">'sort'</span>][$where[<span class="number">0</span>]][<span class="string">'order'</span>] = $where[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//分组查询</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'group_key'</span>]))&#123;</span><br><span class="line">            $reqdata[<span class="string">'aggs'</span>][$where[<span class="string">'group_key'</span>]][<span class="string">'terms'</span>][<span class="string">'field'</span>] = $where[<span class="string">'group_key'</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//过滤查询 == end</span></span><br><span class="line">        <span class="comment">//模糊搜索条件</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'search_key'</span>]) &amp;&amp; <span class="keyword">isset</span>($where[<span class="string">'search_value'</span>]))&#123;$reqdata[<span class="string">'query'</span>][<span class="string">'match'</span>][$where[<span class="string">'search_key'</span>]] = $where[<span class="string">'search_value'</span>];&#125;</span><br><span class="line">        <span class="comment">//返回字段</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'field'</span>]))&#123;</span><br><span class="line">            <span class="keyword">if</span>(is_array($where[<span class="string">'field'</span>]))&#123;$reqdata[<span class="string">'_source'</span>] = $where[<span class="string">'field'</span>];&#125;</span><br><span class="line">            <span class="keyword">if</span>(is_string($where[<span class="string">'field'</span>]))&#123; $where[<span class="string">'field'</span>] = explode(<span class="string">','</span>,$where[<span class="string">'field'</span>]);&#125;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exwstr($where[<span class="string">'field'</span>],$reqdata,$where);<span class="comment">//分析查询</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">empty</span>($where[<span class="string">'field'</span>]))&#123; $reqdata[<span class="string">'_source'</span>] = $where[<span class="string">'field'</span>];&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//分页</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'limit'</span>]) || <span class="keyword">isset</span>($where[<span class="string">'size'</span>]) )&#123; $reqdata[<span class="string">'size'</span>] = <span class="keyword">isset</span>($where[<span class="string">'limit'</span>])?$where[<span class="string">'limit'</span>]:$where[<span class="string">'size'</span>];&#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'start'</span>]) || <span class="keyword">isset</span>($where[<span class="string">'from'</span>]))&#123; $reqdata[<span class="string">'from'</span>] = <span class="keyword">isset</span>($where[<span class="string">'start'</span>])?$where[<span class="string">'start'</span>]:$where[<span class="string">'from'</span>];&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//基础请求封装</span></span><br><span class="line">        $url = <span class="keyword">$this</span>-&gt;host;</span><br><span class="line">        $method  = <span class="string">'POST'</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'method'</span>]))&#123; $method = $where[<span class="string">'method'</span>]; &#125;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($where[<span class="string">'index'</span>]))&#123; <span class="keyword">return</span> <span class="keyword">false</span>; &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'host'</span>]))&#123; $url = $where[<span class="string">'host'</span>]; &#125;</span><br><span class="line">        <span class="keyword">if</span>(substr($url, <span class="number">-1</span>) != <span class="string">'/'</span>)&#123; $url .=<span class="string">'/'</span>; &#125;</span><br><span class="line">        $url .= $where[<span class="string">'index'</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'search'</span>]))&#123;</span><br><span class="line">            $url .= <span class="string">'/'</span>.$where[<span class="string">'search'</span>];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $url .= <span class="string">'/_search'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $result = <span class="keyword">$this</span>-&gt;post_url($url,json_encode($reqdata,<span class="number">320</span>),$method);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;analysis($result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**解析数组</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> $wdata</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">exwstr</span><span class="params">(&amp;$wdata,&amp;$reqdata,&amp;$where)</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($wdata <span class="keyword">as</span> $key=&gt; $item)&#123;</span><br><span class="line">            $item = strtolower($item);</span><br><span class="line">            <span class="keyword">if</span>(strpos($item,<span class="string">'('</span>) === <span class="keyword">false</span>)&#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">            $cardinality = <span class="string">''</span>;</span><br><span class="line">            <span class="comment">//存在运算操作</span></span><br><span class="line">            <span class="keyword">if</span>(strpos($item,<span class="string">'sum'</span>) !== <span class="keyword">false</span> )&#123;$cardinality = <span class="string">'sum'</span>;&#125;</span><br><span class="line">            <span class="keyword">if</span>(strpos($item,<span class="string">'avg'</span>) !== <span class="keyword">false</span> )&#123;$cardinality = <span class="string">'avg'</span>;&#125;</span><br><span class="line">            <span class="comment">//去重</span></span><br><span class="line">            <span class="keyword">if</span>(strpos($item,<span class="string">'distinct'</span>) !== <span class="keyword">false</span> )&#123; $cardinality  = <span class="string">'cardinality'</span>;&#125;</span><br><span class="line">            <span class="keyword">if</span>(strpos($item,<span class="string">'min'</span>) !== <span class="keyword">false</span> )&#123; $cardinality  = <span class="string">'min'</span>;&#125;</span><br><span class="line">            <span class="keyword">if</span>(strpos($item,<span class="string">'max'</span>) !== <span class="keyword">false</span> )&#123; $cardinality  = <span class="string">'max'</span>;&#125;</span><br><span class="line">            $newstr =  explode(<span class="string">' '</span>,$item);</span><br><span class="line">            <span class="keyword">if</span>(strpos($item,<span class="string">' as '</span>) !== <span class="keyword">false</span>)&#123;</span><br><span class="line">                preg_match_all(<span class="string">"/[^(*)]+/"</span>,$item,$str_ary);</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'group_key'</span>]))&#123;</span><br><span class="line">                    $reqdata[<span class="string">'aggs'</span>][$where[<span class="string">'group_key'</span>]][<span class="string">'aggs'</span>][trim($newstr[<span class="number">2</span>])][$cardinality][<span class="string">'field'</span>] = trim($str_ary[<span class="number">0</span>][<span class="number">1</span>]);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    $reqdata[<span class="string">'aggs'</span>][trim($newstr[<span class="number">2</span>])][$cardinality][<span class="string">'field'</span>] = trim($str_ary[<span class="number">0</span>][<span class="number">1</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                preg_match_all(<span class="string">"/[^(*)]+/"</span>,$item,$str_ary);</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">isset</span>($where[<span class="string">'group_key'</span>]))&#123;</span><br><span class="line">                    $reqdata[<span class="string">'aggs'</span>][$where[<span class="string">'group_key'</span>]][<span class="string">'aggs'</span>][trim($newstr[<span class="number">2</span>])][$cardinality][<span class="string">'field'</span>] = trim($str_ary[<span class="number">0</span>][<span class="number">1</span>]);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    $reqdata[<span class="string">'aggs'</span>][trim($str_ary[<span class="number">0</span>][<span class="number">1</span>])][$cardinality][<span class="string">'field'</span>] = trim($str_ary[<span class="number">0</span>][<span class="number">1</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//处理完删除元素</span></span><br><span class="line">            <span class="keyword">unset</span>($wdata[$key]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**处理sql</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> $where</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">exsql</span><span class="params">(&amp;$sql)</span></span>&#123;</span><br><span class="line">        $url = <span class="keyword">$this</span>-&gt;host.<span class="string">'_xpack/sql?format=json'</span>;</span><br><span class="line">        $xml_data= <span class="string">'&#123;"query": '</span>.<span class="string">'"'</span>.$sql.<span class="string">'"'</span>.<span class="string">'&#125;'</span>;</span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;post_url($url,$xml_data,<span class="string">'POST'</span>);</span><br><span class="line">        $res=json_decode($response,<span class="keyword">true</span>);</span><br><span class="line">        $data = [];</span><br><span class="line">        <span class="keyword">foreach</span> ($res[<span class="string">'rows'</span>] <span class="keyword">as</span> $key=&gt;$val)&#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($res[<span class="string">'columns'</span>] <span class="keyword">as</span> $k=&gt;$v)&#123;</span><br><span class="line">                $data[$key][$v[<span class="string">'name'</span>]] = $val[$k];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://wulimax.github.io/2019/09/16/docs/maxwell/ESapi/" data-id="ck0m2ip3c000oq4u1h62ilfx5" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; 上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/09/16/url/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/09/16/README/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/09/16/docs/wx/README/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/09/16/docs/wx/intercepto/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/09/16/docs/TopN/README/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 wulimax<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>